@model IGB.Web.ViewModels.ChangePasswordViewModel
@{
    ViewData["Title"] = "Change Password";
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: "Change Password",
    Icon: "fas fa-key",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Home", Url.Action("Index", "Home")),
        new("Change Password")
    }
))

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-xl-5">
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                            <i class="fas fa-lock text-primary fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0 fw-semibold">Update Your Password</h5>
                            <p class="text-muted small mb-0">Enter your current password and choose a new secure password</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form asp-action="ChangePassword" method="post" id="changePasswordForm">
                        @Html.AntiForgeryToken()

                        <div class="mb-4">
                            <label asp-for="CurrentPassword" class="form-label fw-semibold">
                                <i class="fas fa-key me-2 text-muted"></i>Current Password
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-lock text-muted"></i>
                                </span>
                                <input asp-for="CurrentPassword" class="form-control border-start-0" type="password" placeholder="Enter your current password" />
                                <button class="btn btn-outline-secondary border-start-0" type="button" onclick="togglePasswordVisibility('CurrentPassword', this)">
                                    <i class="fas fa-eye" id="CurrentPassword-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="CurrentPassword" class="text-danger small d-block mt-1"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="NewPassword" class="form-label fw-semibold">
                                <i class="fas fa-shield-alt me-2 text-muted"></i>New Password
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-lock text-muted"></i>
                                </span>
                                <input asp-for="NewPassword" class="form-control border-start-0" type="password" placeholder="Enter your new password" id="NewPassword" />
                                <button class="btn btn-outline-secondary border-start-0" type="button" onclick="togglePasswordVisibility('NewPassword', this)">
                                    <i class="fas fa-eye" id="NewPassword-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger small d-block mt-1"></span>
                            <div class="password-requirements mt-2 p-3 bg-light rounded small">
                                <div class="fw-semibold mb-2">Password Requirements:</div>
                                <ul class="mb-0 ps-3" style="list-style: none;">
                                    <li class="mb-1">
                                        <i class="fas fa-check-circle text-success me-2" id="req-length"></i>
                                        <i class="fas fa-circle text-muted me-2 d-none" id="req-length-empty"></i>
                                        At least 8 characters
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check-circle text-success me-2 d-none" id="req-upper"></i>
                                        <i class="fas fa-circle text-muted me-2" id="req-upper-empty"></i>
                                        One uppercase letter
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check-circle text-success me-2 d-none" id="req-lower"></i>
                                        <i class="fas fa-circle text-muted me-2" id="req-lower-empty"></i>
                                        One lowercase letter
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-check-circle text-success me-2 d-none" id="req-number"></i>
                                        <i class="fas fa-circle text-muted me-2" id="req-number-empty"></i>
                                        One number or special character
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ConfirmNewPassword" class="form-label fw-semibold">
                                <i class="fas fa-check-double me-2 text-muted"></i>Confirm New Password
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-lock text-muted"></i>
                                </span>
                                <input asp-for="ConfirmNewPassword" class="form-control border-start-0" type="password" placeholder="Confirm your new password" id="ConfirmNewPassword" />
                                <button class="btn btn-outline-secondary border-start-0" type="button" onclick="togglePasswordVisibility('ConfirmNewPassword', this)">
                                    <i class="fas fa-eye" id="ConfirmNewPassword-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmNewPassword" class="text-danger small d-block mt-1"></span>
                            <div id="passwordMatch" class="mt-2 small d-none">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                <span class="text-success">Passwords match</span>
                            </div>
                            <div id="passwordMismatch" class="mt-2 small d-none">
                                <i class="fas fa-times-circle text-danger me-1"></i>
                                <span class="text-danger">Passwords do not match</span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end align-items-center gap-3 pt-3 border-top">
                          
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-save me-2"></i>Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="text-center mt-4">
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    If you've forgotten your password, please contact an administrator.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        function togglePasswordVisibility(fieldId, button) {
            const input = document.getElementById(fieldId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password strength checking
        document.getElementById('NewPassword')?.addEventListener('input', function(e) {
            const password = e.target.value;
            
            // Check requirements
            const hasLength = password.length >= 8;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password) || /[^A-Za-z0-9]/.test(password);
            
            // Update requirement indicators
            toggleRequirement('req-length', 'req-length-empty', hasLength);
            toggleRequirement('req-upper', 'req-upper-empty', hasUpper);
            toggleRequirement('req-lower', 'req-lower-empty', hasLower);
            toggleRequirement('req-number', 'req-number-empty', hasNumber);
            
            // Check password match
            checkPasswordMatch();
        });

        document.getElementById('ConfirmNewPassword')?.addEventListener('input', function() {
            checkPasswordMatch();
        });

        function toggleRequirement(checkId, emptyId, isValid) {
            const checkIcon = document.getElementById(checkId);
            const emptyIcon = document.getElementById(emptyId);
            
            if (isValid) {
                checkIcon?.classList.remove('d-none');
                emptyIcon?.classList.add('d-none');
            } else {
                checkIcon?.classList.add('d-none');
                emptyIcon?.classList.remove('d-none');
            }
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('NewPassword')?.value || '';
            const confirmPassword = document.getElementById('ConfirmNewPassword')?.value || '';
            const matchDiv = document.getElementById('passwordMatch');
            const mismatchDiv = document.getElementById('passwordMismatch');
            
            if (confirmPassword === '') {
                matchDiv?.classList.add('d-none');
                mismatchDiv?.classList.add('d-none');
                return;
            }
            
            if (newPassword === confirmPassword && newPassword.length >= 8) {
                matchDiv?.classList.remove('d-none');
                mismatchDiv?.classList.add('d-none');
            } else {
                matchDiv?.classList.add('d-none');
                mismatchDiv?.classList.remove('d-none');
            }
        }
    </script>
}


