@model IGB.Domain.Entities.TestReport
@{
    ViewData["Title"] = $"{Model.TestName}";
    var backStudentId = (long?)ViewBag.BackStudentId ?? Model.StudentUserId;
    var topicTitles = Model.Topics.Where(t => !t.IsDeleted && t.CourseTopic != null).Select(t => t.CourseTopic!.Title).ToList();
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: Model.TestName,
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Dashboard", Url.Action("Index", "Home")),
        new("My Ward", Url.Action("Ward", "TestReports", new { studentUserId = backStudentId })),
        new("Test Reports", Url.Action("Ward", "TestReports", new { studentUserId = backStudentId })),
        new(Model.TestName)
    }
))

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a class="btn btn-outline-secondary" href="@Url.Action("Ward","TestReports", new { studentUserId = backStudentId })">Back</a>
        <a class="btn btn-outline-secondary" target="_blank" href="@Url.Action("WardDetailsPdf","TestReports", new { id = Model.Id, studentUserId = backStudentId })">Download Report (PDF)</a>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <div class="text-muted small">Student</div>
                    <div class="fw-semibold">@Model.StudentUser?.FullName</div>
                    <div class="text-muted small mt-1">Tutor: @Model.TutorUser?.FullName</div>
                </div>
                <div class="text-end">
                    <div class="text-muted small">Course</div>
                    <div class="fw-semibold">@Model.Course?.Name</div>
                    <div class="text-muted small mt-1">@Model.TestDate.ToString("yyyy-MM-dd")</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="mb-3">Marks</h5>
                    <div class="row g-3 align-items-center">
                        <div class="col-md-4 text-center">
                            <span class="badge bg-success" style="font-size:1.3rem;">@Model.Grade</span>
                            <div class="text-muted mt-2">@Model.Percentage.ToString("F2")%</div>
                        </div>
                        <div class="col-md-8">
                            <div class="fs-4 fw-semibold">@Model.ObtainedMarks / @Model.TotalMarks</div>
                            <div class="progress mt-2" style="height:12px;">
                                <div class="progress-bar bg-success" style="width:@Model.Percentage%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="mb-3">Topics Covered</h5>
                    @if (topicTitles.Count == 0)
                    {
                        <div class="text-muted">—</div>
                    }
                    else
                    {
                        <ul class="mb-0">
                            @foreach (var t in topicTitles)
                            {
                                <li>@t</li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Tutor Notes</h5>
                    <div class="mb-2"><strong>Strengths:</strong> @(string.IsNullOrWhiteSpace(Model.Strengths) ? "—" : Model.Strengths)</div>
                    <div class="mb-2"><strong>Areas for Improvement:</strong> @(string.IsNullOrWhiteSpace(Model.AreasForImprovement) ? "—" : Model.AreasForImprovement)</div>
                    <div class="mb-0"><strong>Comments:</strong> @(string.IsNullOrWhiteSpace(Model.TutorComments) ? "—" : Model.TutorComments)</div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Test Paper</h5>
                    @if (string.IsNullOrWhiteSpace(Model.TestFileUrl))
                    {
                        <div class="text-muted">Test paper not uploaded.</div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-muted small">@Model.TestFileName</div>
                            <a class="btn btn-sm btn-outline-primary" href="@Model.TestFileUrl" target="_blank">Download</a>
                        </div>
                        <div class="text-muted small">Preview available via download link.</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>


