@model IGB.Domain.Entities.TestReport
@{
    ViewData["Title"] = $"Test Report: {Model.TestName}";
    var topicTitles = Model.Topics.Where(t => !t.IsDeleted && t.CourseTopic != null).Select(t => t.CourseTopic!.Title).ToList();
    var isPdf = (Model.TestFileContentType ?? "").Equals("application/pdf", StringComparison.OrdinalIgnoreCase);
    var isImage = (Model.TestFileContentType ?? "").StartsWith("image/", StringComparison.OrdinalIgnoreCase);
    var created = (int?)ViewBag.Created ?? 0;
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: Model.TestName,
    Icon: "fas fa-clipboard-list",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Dashboard", Url.Action("Index", "Home")),
        new("Test Reports", Url.Action("Index", "TestReports")),
        new(Model.TestName)
    }
))

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a class="btn btn-outline-secondary" href="@Url.Action("Index","TestReports")">Back</a>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="@Url.Action("Edit","TestReports", new { id = Model.Id })">Edit</a>
            <form method="post" asp-action="Delete" asp-route-id="@Model.Id" class="d-inline" onsubmit="return confirm('Delete this test report?');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger">Delete</button>
            </form>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small">Course</div>
                            <div class="fw-semibold">@Model.Course?.Name</div>
                        </div>
                        <div class="text-end">
                            <div class="text-muted small">Date</div>
                            <div class="fw-semibold">@Model.TestDate.ToString("yyyy-MM-dd")</div>
                        </div>
                    </div>

                    <hr />

                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="text-muted small">Grade</div>
                            <div class="fs-3 fw-semibold">@Model.Grade</div>
                            <div class="text-muted">@Model.Percentage.ToString("F2")%</div>
                        </div>
                        <div class="col-md-8">
                            <div class="text-muted small">Marks</div>
                            <div class="fs-4 fw-semibold">@Model.ObtainedMarks / @Model.TotalMarks</div>
                            <div class="progress mt-2" style="height:10px;">
                                <div class="progress-bar bg-success" style="width:@Model.Percentage%"></div>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <div class="small">
                        <div><strong>Student:</strong> @Model.StudentUser?.FullName (@Model.StudentUser?.Email)</div>
                        <div><strong>Tutor:</strong> @Model.TutorUser?.FullName (@Model.TutorUser?.Email)</div>
                        <div><strong>Status:</strong> <span class="badge @(Model.IsDraft ? "bg-secondary" : "bg-success")">@(Model.IsDraft ? "Draft" : "Submitted")</span></div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="mb-3">Topics Covered</h5>
                    @if (topicTitles.Count == 0)
                    {
                        <div class="text-muted">—</div>
                    }
                    else
                    {
                        <ul class="mb-0">
                            @foreach (var t in topicTitles)
                            {
                                <li>@t</li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Performance Analysis</h5>
                    <div class="mb-3">
                        <div class="text-muted small">Strengths</div>
                        <div>@(string.IsNullOrWhiteSpace(Model.Strengths) ? "—" : Model.Strengths)</div>
                    </div>
                    <div class="mb-3">
                        <div class="text-muted small">Areas for Improvement</div>
                        <div>@(string.IsNullOrWhiteSpace(Model.AreasForImprovement) ? "—" : Model.AreasForImprovement)</div>
                    </div>
                    <div class="mb-0">
                        <div class="text-muted small">Tutor Comments</div>
                        <div>@(string.IsNullOrWhiteSpace(Model.TutorComments) ? "—" : Model.TutorComments)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Test Paper</h5>
                    @if (string.IsNullOrWhiteSpace(Model.TestFileUrl))
                    {
                        <div class="text-muted">Test paper not uploaded.</div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="text-muted small">@Model.TestFileName</div>
                            <a class="btn btn-sm btn-outline-primary" href="@Model.TestFileUrl" target="_blank">Download</a>
                        </div>

                        @if (isPdf)
                        {
                            <iframe src="@Model.TestFileUrl" style="width:100%;height:520px;border:1px solid #e5e7eb;"></iframe>
                        }
                        else if (isImage)
                        {
                            <img src="@Model.TestFileUrl" alt="Test paper" class="img-fluid rounded border" />
                        }
                        else
                        {
                            <div class="text-muted">Preview not available for this file type.</div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (!Model.IsDraft && created == 1)
{
    <script>
      // After successful submit, redirect to student profile after a short pause (per spec)
      setTimeout(function(){
        window.location.href = '@Url.Action("Student","Progress", new { studentUserId = Model.StudentUserId })';
      }, 2000);
    </script>
}


