@model IGB.Web.ViewModels.TestReports.StudentMyTestReportsViewModel
@{
    ViewData["Title"] = "My Test Reports";
    
    var filters = new List<PageHeaderFilter>();
    
    if (Model.Courses.Count > 0)
    {
        var courseOptions = Model.Courses.Select(c => new KeyValuePair<string, string>(c.Id.ToString(), c.Name)).Prepend(new KeyValuePair<string, string>("", "All")).ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        filters.Add(new PageHeaderFilter(
            Name: "courseId",
            Label: "Course",
            Type: "select",
            Value: Model.CourseId?.ToString(),
            Options: courseOptions
        ));
    }
    
    if (Model.GradeOptions.Count > 0)
    {
        var gradeOptions = Model.GradeOptions.ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        gradeOptions = new Dictionary<string, string> { { "", "All" } }.Concat(gradeOptions).ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        filters.Add(new PageHeaderFilter(
            Name: "grade",
            Label: "Grade",
            Type: "select",
            Value: Model.Grade,
            Options: gradeOptions
        ));
    }
    
    var pageSizeOptions = new Dictionary<string, string>
    {
        { "10", "10" },
        { "25", "25" },
        { "50", "50" }
    };
    filters.Add(new PageHeaderFilter(
        Name: "pageSize",
        Label: "Rows",
        Type: "select",
        Value: Model.PageSize.ToString(),
        Options: pageSizeOptions
    ));
    
    // Build grid/list toggle URLs with all filters preserved
    var gridParams = new Dictionary<string, string?>
    {
        { "view", "grid" },
        { "courseId", Model.CourseId?.ToString() },
        { "grade", Model.Grade },
        { "q", Model.Query },
        { "pageSize", Model.PageSize.ToString() },
        { "page", "1" }
    };
    var listParams = new Dictionary<string, string?>
    {
        { "view", "list" },
        { "courseId", Model.CourseId?.ToString() },
        { "grade", Model.Grade },
        { "q", Model.Query },
        { "pageSize", Model.PageSize.ToString() },
        { "page", "1" }
    };
    
    var actionButtons = new List<PageHeaderActionButton>();
    
    // Note: Grid/List toggle will be added via custom HTML after header
    
    if (Model.CourseId.HasValue || !string.IsNullOrWhiteSpace(Model.Grade) || !string.IsNullOrWhiteSpace(Model.Query))
    {
        actionButtons.Add(new PageHeaderActionButton(
            Text: "Reset",
            Url: Url.Action("My", "TestReports", new { view = Model.View }),
            Icon: "fas fa-times me-1",
            ButtonType: "outline-secondary"
        ));
    }
    
    var pageHeader = new PageHeaderViewModel(
        Title: "My Test Reports",
        Icon: "fas fa-clipboard-check",
        Breadcrumbs: new List<BreadcrumbItem>
        {
            new("Dashboard", Url.Action("Index", "Home")),
            new("My Tests")
        },
        Search: new PageHeaderSearch(
            QueryParamName: "q",
            CurrentValue: Model.Query,
            Placeholder: "Search by test name..."
        ),
        Filters: filters.Count > 0 ? filters : null,
        ActionButtons: actionButtons.Count > 0 ? actionButtons : null
    );
}

<partial name="_PageHeader" model="pageHeader" />

<!-- Grid/List View Toggle - Integrated with header area -->
<div class="container-fluid" style="margin-top: -1rem; margin-bottom: 1rem;">
    <div class="d-flex justify-content-end gap-2 align-items-center">
        <div class="btn-group btn-group-sm" role="group">
            <a class="btn @(Model.View=="grid"?"btn-primary":"btn-outline-primary")" href="@Url.Action("My","TestReports", gridParams)">
                <i class="fas fa-th me-1"></i>Grid
            </a>
            <a class="btn @(Model.View=="list"?"btn-primary":"btn-outline-primary")" href="@Url.Action("My","TestReports", listParams)">
                <i class="fas fa-list me-1"></i>List
            </a>
        </div>
    </div>
</div>

<div class="container-fluid">

    @if (Model.Items.Count == 0)
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="fs-5 fw-semibold">No test reports yet</div>
                <div class="text-muted">When your tutor uploads test reports, youâ€™ll see them here.</div>
            </div>
        </div>
    }
    else if (Model.View == "list")
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th>Course</th>
                            <th>Test Name</th>
                            <th>Tutor</th>
                            <th>Marks</th>
                            <th>Percentage</th>
                            <th>Grade</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var r in Model.Items)
                        {
                            <tr>
                                <td class="text-muted">@r.TestDate.ToString("yyyy-MM-dd")</td>
                                <td>@r.CourseName</td>
                                <td class="fw-semibold">@r.TestName</td>
                                <td class="text-muted">@(r.TutorName ?? "-")</td>
                                <td class="text-muted">@r.ObtainedMarks / @r.TotalMarks</td>
                                <td class="text-muted">@r.Percentage.ToString("F2")%</td>
                                <td><span class="badge bg-primary">@r.Grade</span></td>
                                <td class="text-end">
                                    <a class="btn btn-sm btn-outline-primary" href="@Url.Action("MyDetails","TestReports", new { id = r.Id })">View</a>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                @if (Model.Pagination.TotalCount > 0)
                {
                    <partial name="Components/_Pagination" model="Model.Pagination" />
                }
            </div>
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var r in Model.Items)
            {
                var gradeVariant = r.Grade.StartsWith("A") ? "bg-success" : (r.Grade.StartsWith("B") ? "bg-primary" : (r.Grade.StartsWith("C") ? "bg-warning text-dark" : "bg-danger"));
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">@r.CourseName</span>
                                <span class="text-muted small">@r.TestDate.ToString("yyyy-MM-dd")</span>
                            </div>
                            <div class="mt-3 fw-semibold fs-5">@r.TestName</div>
                            <div class="text-muted small mt-1">
                                Tutor: @(r.TutorName ?? "-")
                            </div>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <span class="badge @gradeVariant" style="font-size:1rem;">@r.Grade</span>
                                <div class="text-muted">@r.ObtainedMarks / @r.TotalMarks</div>
                            </div>
                            <div class="mt-2">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>@r.Percentage.ToString("F2")%</span>
                                    <span>100%</span>
                                </div>
                                <div class="progress" style="height:10px;">
                                    <div class="progress-bar bg-success" style="width:@r.Percentage%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0">
                            <a class="btn btn-primary w-100" href="@Url.Action("MyDetails","TestReports", new { id = r.Id })">View Details</a>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (Model.Pagination.TotalCount > 0)
        {
            <partial name="Components/_Pagination" model="Model.Pagination" />
        }
    }
</div>

@section Scripts {
    <script>
        // Preserve view parameter in all filter forms
        document.addEventListener('DOMContentLoaded', function() {
            const viewParam = '@Model.View';
            const filterForms = document.querySelectorAll('form[method="get"]');
            filterForms.forEach(form => {
                // Check if view input already exists
                if (!form.querySelector('input[name="view"]')) {
                    const viewInput = document.createElement('input');
                    viewInput.type = 'hidden';
                    viewInput.name = 'view';
                    viewInput.value = viewParam;
                    form.appendChild(viewInput);
                }
            });
        });
    </script>
}

