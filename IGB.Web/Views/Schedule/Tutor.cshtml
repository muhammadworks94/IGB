@model IGB.Web.ViewModels.Schedule.SchedulePageViewModel
@{
    ViewData["Title"] = "My Schedule";
    var mode = (string?)ViewBag.ViewMode ?? "calendar";
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: "My Schedule",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Dashboard", Url.Action("Index", "Home")),
        new("My Schedule")
    },
    Subtitle: string.IsNullOrWhiteSpace(Model.DisplayTimeZoneId) ? null : $"Time zone: {Model.DisplayTimeZoneId}"
))

<div class="container-fluid">
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <input type="hidden" name="view" value="@mode" />
                <div class="col-md-3">
                    <label class="form-label">Course</label>
                    <select class="form-select" name="courseId">
                        <option value="">All</option>
                        @foreach (var c in Model.Courses)
                        {
                            <option value="@c.Id" selected="@(Model.CourseId == c.Id)">@c.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(Model.Status))">All</option>
                        <option value="Upcoming" selected="@(string.Equals(Model.Status,"Upcoming",StringComparison.OrdinalIgnoreCase))">Upcoming</option>
                        <option value="Completed" selected="@(string.Equals(Model.Status,"Completed",StringComparison.OrdinalIgnoreCase))">Completed</option>
                        <option value="Cancelled" selected="@(string.Equals(Model.Status,"Cancelled",StringComparison.OrdinalIgnoreCase))">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From</label>
                    <input class="form-control" name="from" type="date" value="@(Model.From?.ToString("yyyy-MM-dd") ?? "")" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">To</label>
                    <input class="form-control" name="to" type="date" value="@(Model.To?.ToString("yyyy-MM-dd") ?? "")" />
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button class="btn btn-primary" type="submit">Filter</button>
                    <a class="btn btn-outline-secondary" href="@Url.Action("ExportIcal","Schedule", new { scope = "tutor" })">Export iCal</a>
                    <a class="btn btn-outline-secondary" target="_blank" href="@Url.Action("ExportPdf","Schedule", new { scope = "tutor", courseId = Model.CourseId, status = Model.Status, from = Model.From?.ToString("yyyy-MM-dd"), to = Model.To?.ToString("yyyy-MM-dd") })">PDF</a>
                </div>
            </form>

            <div class="mt-3 d-flex gap-2">
                <a class="btn btn-sm @(mode=="calendar"?"btn-primary":"btn-outline-primary")" href="@Url.Action("Tutor","Schedule", new { view="calendar", courseId=Model.CourseId, status=Model.Status, from=Model.From?.ToString("yyyy-MM-dd"), to=Model.To?.ToString("yyyy-MM-dd") })">Calendar</a>
                <a class="btn btn-sm @(mode=="list"?"btn-primary":"btn-outline-primary")" href="@Url.Action("Tutor","Schedule", new { view="list", courseId=Model.CourseId, status=Model.Status, from=Model.From?.ToString("yyyy-MM-dd"), to=Model.To?.ToString("yyyy-MM-dd") })">List</a>
                <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Index","TutorAvailability")">Availability</a>
            </div>
        </div>
    </div>

    @if (mode == "list")
    {
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Upcoming lessons</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Course</th>
                            <th>Student</th>
                            <th>When</th>
                            <th>Status</th>
                            <th>Zoom</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var l in Model.Upcoming)
                        {
                            <tr>
                                <td>@l.CourseName</td>
                                <td class="text-muted">@l.StudentName</td>
                                <td class="text-muted">
                                    <span class="js-dt" data-utc="@l.StartUtc.ToString("O")"></span>
                                    <span class="text-muted">-</span>
                                    <span class="js-t" data-utc="@l.EndUtc.ToString("O")"></span>
                                </td>
                                <td>
                                    <span class="badge @(l.StatusLabel == "Upcoming" ? "bg-primary" : (l.StatusLabel == "Completed" ? "bg-success" : "bg-secondary"))">@l.StatusLabel</span>
                                </td>
                                <td class="text-muted small">
                                    @if (!string.IsNullOrWhiteSpace(l.ZoomMeetingId))
                                    {
                                        <div><strong>ID:</strong> @l.ZoomMeetingId</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(l.ZoomPassword))
                                    {
                                        <div><strong>Pass:</strong> @l.ZoomPassword</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(l.ZoomJoinUrl))
                                    {
                                        <div class="text-truncate" style="max-width:280px;"><strong>Link:</strong> <a target="_blank" href="@l.ZoomJoinUrl">Join URL</a></div>
                                    }
                                </td>
                                <td class="text-end">
                                    @if (l.CanJoin && !string.IsNullOrWhiteSpace(l.ZoomJoinUrl))
                                    {
                                        <a class="btn btn-sm btn-success" target="_blank" href="@l.ZoomJoinUrl">Start class</a>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Calendar</h5>
                    <div class="text-muted small">Click a lesson to start class when available.</div>
                </div>
                <div id="scheduleCalendar"></div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <link rel="stylesheet" href="/nobleui/vendors/fullcalendar/main.min.css" />
    <script src="/nobleui/vendors/fullcalendar/main.min.js"></script>
    <script>
      (function(){
        function fmtDateTime(isoUtc) {
          if (!isoUtc) return "";
          const d = new Date(isoUtc);
          const tz = '@Model.CalendarTimeZone';
          const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
          try {
            if (tz && tz !== 'local') return new Intl.DateTimeFormat(undefined, { ...opts, timeZone: tz }).format(d);
          } catch {}
          return new Intl.DateTimeFormat(undefined, opts).format(d);
        }
        function fmtTime(isoUtc) {
          if (!isoUtc) return "";
          const d = new Date(isoUtc);
          const tz = '@Model.CalendarTimeZone';
          const opts = { hour: '2-digit', minute: '2-digit' };
          try {
            if (tz && tz !== 'local') return new Intl.DateTimeFormat(undefined, { ...opts, timeZone: tz }).format(d);
          } catch {}
          return new Intl.DateTimeFormat(undefined, opts).format(d);
        }

        document.querySelectorAll('.js-dt').forEach(el => {
          el.textContent = fmtDateTime(el.getAttribute('data-utc'));
        });
        document.querySelectorAll('.js-t').forEach(el => {
          el.textContent = fmtTime(el.getAttribute('data-utc'));
        });

        const el = document.getElementById('scheduleCalendar');
        if (!el || typeof FullCalendar === 'undefined') return;

        const url = '@Url.Action("Events","Schedule")' +
          '?scope=tutor' +
          '&courseId=@(Model.CourseId?.ToString() ?? "")' +
          '&status=@(Model.Status ?? "")' +
          '&from=@(Model.From?.ToString("yyyy-MM-dd") ?? "")' +
          '&to=@(Model.To?.ToString("yyyy-MM-dd") ?? "")';

        function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
        function applyRichTitle(info){
          const el = info?.el;
          const ev = info?.event;
          if (!el || !ev) return;
          const p = ev.extendedProps || {};
          const course = p.courseName || ev.title || '';
          const student = p.studentName || '';
          const titleEl = el.querySelector('.fc-event-title, .fc-title');
          if (!titleEl) return;
          const parts = [`<div class="igb-fc-title">${esc(course)}</div>`];
          if (student) parts.push(`<div class="igb-fc-meta">Student: ${esc(student)}</div>`);
          titleEl.innerHTML = parts.join('');
        }

        const cal = new FullCalendar.Calendar(el, {
          initialView: 'timeGridWeek',
          headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
          height: 'auto',
          expandRows: true,
          nowIndicator: true,
          timeZone: '@Model.CalendarTimeZone',
          eventDidMount: applyRichTitle,
          eventRender: applyRichTitle, // v4 fallback
          events: async (info, success) => {
            const res = await fetch(url, { credentials: 'include' });
            const data = await res.json();
            success(data.map(e => ({
              id: e.id,
              title: e.title,
              start: e.start,
              end: e.end,
              color: e.color,
              extendedProps: {
                status: e.status,
                joinUrl: e.joinUrl,
                canJoin: e.canJoin,
                zoomMeetingId: e.zoomMeetingId,
                zoomPassword: e.zoomPassword,
                courseName: e.courseName,
                studentName: e.studentName
              }
            })));
          },
          eventClick: (info) => {
            const p = info.event.extendedProps || {};
            if (p.canJoin && p.joinUrl) window.open(p.joinUrl, '_blank');
          }
        });
        cal.render();
      })();
    </script>
}


