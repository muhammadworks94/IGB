@model List<IGB.Web.ViewModels.Schedule.SchedulePageViewModel.ListRow>
@{
    Layout = "_Layout";
    ViewData["Title"] = "Schedule (PDF)";
    var scope = (string?)ViewBag.Scope ?? "schedule";
    var tz = (string?)ViewBag.CalendarTimeZone ?? "local";
    var tzLabel = (string?)ViewBag.DisplayTimeZoneId;
    DateTime? from = (DateTime?)ViewBag.From;
    DateTime? to = (DateTime?)ViewBag.To;
}

<style>
  @@media print {
    .no-print { display:none !important; }
    body { background: #fff !important; }
  }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center no-print my-3">
        <div class="text-muted small">Use your browser print dialog and choose “Save as PDF”.</div>
        <button class="btn btn-primary" onclick="window.print()">Print / Save PDF</button>
    </div>

    <h4 class="mb-2 text-capitalize">@scope schedule</h4>
    <div class="text-muted small mb-3">
        Range: @(from?.ToString("yyyy-MM-dd") ?? "—") to @(to?.ToString("yyyy-MM-dd") ?? "—") • Time zone: @(tzLabel ?? tz)
    </div>

    <table class="table table-sm table-bordered align-middle">
        <thead>
        <tr>
            <th>Lesson</th>
            <th>Course</th>
            <th>Student</th>
            <th>Tutor</th>
            <th>When</th>
            <th>Status</th>
            <th>Zoom</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var r in Model)
        {
            <tr>
                <td>#@r.LessonId</td>
                <td>@r.CourseName</td>
                <td>@(r.StudentName ?? "—")</td>
                <td>@(r.TutorName ?? "—")</td>
                <td class="text-muted">
                    <span class="js-dt" data-utc="@r.StartUtc.ToString("O")"></span>
                    -
                    <span class="js-t" data-utc="@r.EndUtc.ToString("O")"></span>
                </td>
                <td>@r.StatusLabel</td>
                <td class="text-muted small">
                    @if (!string.IsNullOrWhiteSpace(r.ZoomMeetingId))
                    {
                        <div>ID: @r.ZoomMeetingId</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(r.ZoomPassword))
                    {
                        <div>Pass: @r.ZoomPassword</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(r.ZoomJoinUrl))
                    {
                        <div class="text-truncate" style="max-width:420px;">Link: @r.ZoomJoinUrl</div>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<script>
  (function(){
    function fmtDateTime(isoUtc) {
      if (!isoUtc) return "";
      const d = new Date(isoUtc);
      const tz = '@tz';
      const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
      try {
        if (tz && tz !== 'local') return new Intl.DateTimeFormat(undefined, { ...opts, timeZone: tz }).format(d);
      } catch {}
      return new Intl.DateTimeFormat(undefined, opts).format(d);
    }
    function fmtTime(isoUtc) {
      if (!isoUtc) return "";
      const d = new Date(isoUtc);
      const tz = '@tz';
      const opts = { hour: '2-digit', minute: '2-digit' };
      try {
        if (tz && tz !== 'local') return new Intl.DateTimeFormat(undefined, { ...opts, timeZone: tz }).format(d);
      } catch {}
      return new Intl.DateTimeFormat(undefined, opts).format(d);
    }

    document.querySelectorAll('.js-dt').forEach(el => el.textContent = fmtDateTime(el.getAttribute('data-utc')));
    document.querySelectorAll('.js-t').forEach(el => el.textContent = fmtTime(el.getAttribute('data-utc')));
    window.addEventListener('load', () => setTimeout(() => window.print(), 250));
  })();
</script>


