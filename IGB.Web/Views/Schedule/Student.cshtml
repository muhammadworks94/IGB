@model IGB.Web.ViewModels.Schedule.SchedulePageViewModel
@{
    ViewData["Title"] = "My Schedule";
    var mode = (string?)ViewBag.ViewMode ?? "calendar";
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: "My Schedule",
    Icon: "fas fa-calendar-alt",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Dashboard", Url.Action("Index", "Home")),
        new("My Schedule")
    },
    Subtitle: string.IsNullOrWhiteSpace(Model.DisplayTimeZoneId) ? null : $"Time zone: {Model.DisplayTimeZoneId}"
))

<div class="container-fluid">
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <input type="hidden" name="view" value="@mode" />
                <div class="col-md-3">
                    <label class="form-label">Course</label>
                    <select class="form-select" name="courseId">
                        <option value="">All</option>
                        @foreach (var c in Model.Courses)
                        {
                            <option value="@c.Id" selected="@(Model.CourseId == c.Id)">@c.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="" selected="@(string.IsNullOrWhiteSpace(Model.Status))">All</option>
                        <option value="Upcoming" selected="@(string.Equals(Model.Status,"Upcoming",StringComparison.OrdinalIgnoreCase))">Upcoming</option>
                        <option value="Completed" selected="@(string.Equals(Model.Status,"Completed",StringComparison.OrdinalIgnoreCase))">Completed</option>
                        <option value="Cancelled" selected="@(string.Equals(Model.Status,"Cancelled",StringComparison.OrdinalIgnoreCase))">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">From</label>
                    <input class="form-control" name="from" type="date" value="@(Model.From?.ToString("yyyy-MM-dd") ?? "")" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">To</label>
                    <input class="form-control" name="to" type="date" value="@(Model.To?.ToString("yyyy-MM-dd") ?? "")" />
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button class="btn btn-primary" type="submit">Filter</button>
                    <a class="btn btn-outline-secondary" href="@Url.Action("ExportIcal","Schedule", new { scope = "student" })">Export iCal</a>
                    <a class="btn btn-outline-secondary" target="_blank" href="@Url.Action("ExportPdf","Schedule", new { scope = "student", courseId = Model.CourseId, status = Model.Status, from = Model.From?.ToString("yyyy-MM-dd"), to = Model.To?.ToString("yyyy-MM-dd") })">PDF</a>
                </div>
            </form>

            <div class="mt-3 d-flex gap-2">
                <a class="btn btn-sm @(mode=="calendar"?"btn-primary":"btn-outline-primary")" href="@Url.Action("My","Schedule", new { view="calendar", courseId=Model.CourseId, status=Model.Status, from=Model.From?.ToString("yyyy-MM-dd"), to=Model.To?.ToString("yyyy-MM-dd") })">Calendar</a>
                <a class="btn btn-sm @(mode=="list"?"btn-primary":"btn-outline-primary")" href="@Url.Action("My","Schedule", new { view="list", courseId=Model.CourseId, status=Model.Status, from=Model.From?.ToString("yyyy-MM-dd"), to=Model.To?.ToString("yyyy-MM-dd") })">List</a>
            </div>
        </div>
    </div>

    @if (mode == "list")
    {
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Upcoming lessons</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Course</th>
                            <th>Tutor</th>
                            <th>When</th>
                            <th>Status</th>
                            <th>Zoom</th>
                            <th class="text-end">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var l in Model.Upcoming)
                        {
                            <tr>
                                <td>@l.CourseName</td>
                                <td class="text-muted">@l.TutorName</td>
                                <td class="text-muted">
                                    <span class="js-dt" data-utc="@l.StartUtc.ToString("O")"></span>
                                    <span class="text-muted">-</span>
                                    <span class="js-t" data-utc="@l.EndUtc.ToString("O")"></span>
                                </td>
                                <td>
                                    <span class="badge @(l.StatusLabel == "Upcoming" ? "bg-primary" : (l.StatusLabel == "Completed" ? "bg-success" : "bg-secondary"))">@l.StatusLabel</span>
                                </td>
                                <td class="text-muted small">
                                    @if (!string.IsNullOrWhiteSpace(l.ZoomMeetingId))
                                    {
                                        <div><strong>ID:</strong> @l.ZoomMeetingId</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(l.ZoomPassword))
                                    {
                                        <div><strong>Pass:</strong> @l.ZoomPassword</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(l.ZoomJoinUrl))
                                    {
                                        <div class="text-truncate" style="max-width:280px;"><strong>Link:</strong> <a target="_blank" href="@l.ZoomJoinUrl">Join URL</a></div>
                                    }
                                </td>
                                <td class="text-end">
                                    @if (l.CanJoin && !string.IsNullOrWhiteSpace(l.ZoomJoinUrl))
                                    {
                                        <a class="btn btn-sm btn-success" target="_blank" href="@l.ZoomJoinUrl">Join</a>
                                    }
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Calendar</h5>
                    <div class="text-muted small">
                        <i class="fas fa-circle text-primary me-1"></i>Scheduled 
                        <i class="fas fa-circle text-info ms-2 me-1"></i>Rescheduled 
                        <i class="fas fa-circle text-success ms-2 me-1"></i>Completed 
                        <i class="fas fa-circle text-secondary ms-2 me-1"></i>Cancelled 
                        <i class="fas fa-circle text-warning ms-2 me-1"></i>Pending
                    </div>
                </div>
                <style>
                  /* Month view styling */
                  .fc-daygrid-event { padding: 2px 4px; }
                  .fc-daygrid-event .fc-event-title { font-size: 0.85rem; line-height: 1.3; }
                  
                  /* Week and Day view styling - enhanced for visibility */
                  .fc-timegrid-event { 
                    padding: 8px 10px !important; 
                    min-height: 70px !important;
                    border-radius: 6px;
                    overflow: visible !important;
                  }
                  .fc-timegrid-event .fc-event-title { 
                    font-size: 0.95rem !important; 
                    line-height: 1.6 !important; 
                    font-weight: 500;
                    white-space: normal !important;
                    overflow: visible !important;
                    height: auto !important;
                  }
                  .fc-timegrid-event .fc-event-title div {
                    margin-bottom: 4px;
                    display: block;
                  }
                  .fc-timegrid-event .fc-event-title div:last-child {
                    margin-bottom: 0;
                  }
                  
                  /* Ensure short events also have enough height */
                  .fc-timegrid-event-short { 
                    min-height: 70px !important;
                  }
                  .fc-timegrid-event.fc-event-short { 
                    min-height: 70px !important;
                  }
                  
                  /* General event styling */
                  .fc-event { cursor: pointer; border-radius: 4px; }
                  .fc-event:hover { opacity: 0.9; box-shadow: 0 2px 6px rgba(0,0,0,0.15); transform: translateY(-1px); }
                  .igb-fc-title { font-weight: 600; }
                  .igb-fc-meta { font-size: 0.85rem; opacity: 0.9; }
                  
                  /* Prevent text clipping */
                  .fc-timegrid-event .fc-event-main {
                    overflow: visible !important;
                    height: auto !important;
                  }
                  .fc-timegrid-event .fc-event-main-frame {
                    height: auto !important;
                    min-height: 60px !important;
                  }
                </style>
                <div id="scheduleCalendar"></div>
            </div>
        </div>
    }
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1" aria-labelledby="lessonDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lessonDetailsModalLabel">
                    <i class="fas fa-calendar-check me-2"></i><span id="lessonModalTitle">Lesson Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-book text-primary me-2"></i>
                            <div>
                                <div class="text-muted small">Course / Subject</div>
                                <div class="fw-semibold" id="lessonModalCourse">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-user-tie text-info me-2"></i>
                            <div>
                                <div class="text-muted small">Tutor / Teacher</div>
                                <div class="fw-semibold" id="lessonModalTutor">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <div class="text-muted small">Time</div>
                                <div class="fw-semibold" id="lessonModalTime">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-info-circle text-secondary me-2"></i>
                            <div>
                                <div class="text-muted small">Status</div>
                                <div>
                                    <span class="badge" id="lessonModalStatusBadge">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12" id="lessonModalZoom" style="display: none;">
                        <hr />
                        <h6 class="mb-3"><i class="fas fa-video me-2"></i>Zoom Meeting</h6>
                        <div class="mb-2">
                            <div class="text-muted small">Meeting ID</div>
                            <div class="fw-semibold" id="lessonModalMeetingId">-</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-muted small">Password</div>
                            <div class="fw-semibold" id="lessonModalPassword">-</div>
                        </div>
                        <button type="button" class="btn btn-success w-100" id="lessonModalJoinBtn" style="display: none;">
                            <i class="fas fa-video me-2"></i>Join Zoom Meeting
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="/nobleui/vendors/fullcalendar/main.min.css" />
    <script src="/nobleui/vendors/fullcalendar/main.min.js"></script>
    <script>
      (function(){
        function fmtDateTime(isoUtc) {
          if (!isoUtc) return "";
          const d = new Date(isoUtc);
          const tz = '@Model.CalendarTimeZone';
          const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
          try {
            if (tz && tz !== 'local') return new Intl.DateTimeFormat(undefined, { ...opts, timeZone: tz }).format(d);
          } catch {}
          return new Intl.DateTimeFormat(undefined, opts).format(d);
        }
        function fmtTime(isoUtc) {
          if (!isoUtc) return "";
          const d = new Date(isoUtc);
          const tz = '@Model.CalendarTimeZone';
          const opts = { hour: '2-digit', minute: '2-digit' };
          try {
            if (tz && tz !== 'local') return new Intl.DateTimeFormat(undefined, { ...opts, timeZone: tz }).format(d);
          } catch {}
          return new Intl.DateTimeFormat(undefined, opts).format(d);
        }

        document.querySelectorAll('.js-dt').forEach(el => {
          el.textContent = fmtDateTime(el.getAttribute('data-utc'));
        });
        document.querySelectorAll('.js-t').forEach(el => {
          el.textContent = fmtTime(el.getAttribute('data-utc'));
        });

        const el = document.getElementById('scheduleCalendar');
        if (!el || typeof FullCalendar === 'undefined') return;

        const url = '@Url.Action("Events","Schedule")' +
          '?scope=student' +
          '&courseId=@(Model.CourseId?.ToString() ?? "")' +
          '&status=@(Model.Status ?? "")' +
          '&from=@(Model.From?.ToString("yyyy-MM-dd") ?? "")' +
          '&to=@(Model.To?.ToString("yyyy-MM-dd") ?? "")';

        function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
        
        function applyRichTitle(info){
          const el = info?.el;
          const ev = info?.event;
          if (!el || !ev) return;
          const p = ev.extendedProps || {};
          const course = p.courseName || ev.title || '';
          const teacher = p.tutorName || '';
          const view = info.view.type;
          
          // Customize based on view type
          if (view === 'dayGridMonth') {
            // Month view: show course and teacher in compact format
            const titleEl = el.querySelector('.fc-event-title, .fc-title');
            if (titleEl) {
              const parts = [`<div class="fw-semibold">${esc(course)}</div>`];
              if (teacher) parts.push(`<div class="small text-muted">ðŸ‘¤ ${esc(teacher)}</div>`);
              titleEl.innerHTML = parts.join('');
            }
          } else {
            // Week and Day views: show more details with better visibility
            const titleEl = el.querySelector('.fc-event-title, .fc-title');
            if (titleEl) {
              // Ensure event has enough height
              if (el.classList.contains('fc-timegrid-event')) {
                el.style.minHeight = '70px';
                el.style.padding = '8px 10px';
                el.style.overflow = 'visible';
                
                // Also set on parent containers
                const main = el.querySelector('.fc-event-main');
                if (main) {
                  main.style.overflow = 'visible';
                  main.style.height = 'auto';
                }
                const mainFrame = el.querySelector('.fc-event-main-frame');
                if (mainFrame) {
                  mainFrame.style.height = 'auto';
                  mainFrame.style.minHeight = '60px';
                }
              }
              
              const startTime = fmtTime(ev.start);
              const endTime = fmtTime(ev.end);
              
              const parts = [
                `<div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 6px; color: inherit; line-height: 1.3;">${esc(course)}</div>`,
                `<div style="font-size: 0.875rem; margin-bottom: 4px; opacity: 0.95; line-height: 1.4;"><i class="fas fa-user-tie" style="width: 14px; display: inline-block;"></i> ${esc(teacher || 'N/A')}</div>`,
                `<div style="font-size: 0.8rem; opacity: 0.9; line-height: 1.3;"><i class="fas fa-clock" style="width: 14px; display: inline-block;"></i> ${startTime} - ${endTime}</div>`
              ];
              titleEl.innerHTML = parts.join('');
              titleEl.style.whiteSpace = 'normal';
              titleEl.style.overflow = 'visible';
              titleEl.style.textOverflow = 'clip';
              titleEl.style.height = 'auto';
              titleEl.style.lineHeight = '1.5';
            }
          }
        }

        const cal = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
          height: 'auto',
          expandRows: true,
          nowIndicator: true,
          timeZone: '@Model.CalendarTimeZone',
          slotMinTime: '00:00:00',
          slotMaxTime: '24:00:00',
          slotDuration: '00:30:00',
          slotLabelInterval: '01:00:00',
          eventMinHeight: 70,
          eventDidMount: applyRichTitle,
          eventRender: applyRichTitle, // v4 fallback
          events: async (info, success) => {
            const res = await fetch(url, { credentials: 'include' });
            const data = await res.json();
            success(data.map(e => ({
              id: e.id,
              title: e.title,
              start: e.start,
              end: e.end,
              color: e.color,
              extendedProps: {
                status: e.status,
                joinUrl: e.joinUrl,
                canJoin: e.canJoin,
                zoomMeetingId: e.zoomMeetingId,
                zoomPassword: e.zoomPassword,
                courseName: e.courseName,
                tutorName: e.tutorName
              }
            })));
          },
          eventClick: (info) => {
            info.jsEvent.preventDefault();
            const ev = info.event;
            const p = ev.extendedProps || {};
            const start = fmtDateTime(ev.start);
            const end = fmtTime(ev.end);
            
            // Populate modal - check if elements exist before setting
            const modalTitle = document.getElementById('lessonModalTitle');
            const modalCourse = document.getElementById('lessonModalCourse');
            const modalTutor = document.getElementById('lessonModalTutor');
            const modalTime = document.getElementById('lessonModalTime');
            const statusBadge = document.getElementById('lessonModalStatusBadge');
            
            if (modalTitle) modalTitle.textContent = p.courseName || 'Lesson Details';
            if (modalCourse) modalCourse.textContent = p.courseName || 'N/A';
            if (modalTutor) modalTutor.textContent = p.tutorName || 'N/A';
            if (modalTime) modalTime.textContent = `${start} - ${end}`;
            
            // Status badge
            if (statusBadge) {
              const status = (p.status || '').toLowerCase();
              statusBadge.className = 'badge ';
              if (status.includes('completed')) statusBadge.className += 'bg-success';
              else if (status.includes('cancelled') || status.includes('rejected')) statusBadge.className += 'bg-secondary';
              else if (status.includes('scheduled') || status.includes('rescheduled')) statusBadge.className += 'bg-primary';
              else statusBadge.className += 'bg-warning';
              statusBadge.textContent = p.status || 'N/A';
            }
            
            // Zoom info
            const zoomSection = document.getElementById('lessonModalZoom');
            if (zoomSection) {
              if (p.zoomMeetingId || p.joinUrl) {
                zoomSection.style.display = 'block';
                const meetingId = document.getElementById('lessonModalMeetingId');
                const password = document.getElementById('lessonModalPassword');
                const joinBtn = document.getElementById('lessonModalJoinBtn');
                
                if (meetingId) meetingId.textContent = p.zoomMeetingId || 'N/A';
                if (password) password.textContent = p.zoomPassword || 'N/A';
                
                if (joinBtn) {
                  if (p.canJoin && p.joinUrl) {
                    joinBtn.style.display = 'inline-block';
                    joinBtn.onclick = () => window.open(p.joinUrl, '_blank');
                  } else {
                    joinBtn.style.display = 'none';
                  }
                }
              } else {
                zoomSection.style.display = 'none';
              }
            }
            
            // Show modal
            const modalEl = document.getElementById('lessonDetailsModal');
            if (modalEl) {
              const modal = new bootstrap.Modal(modalEl);
              modal.show();
            }
          }
        });
        cal.render();
      })();
    </script>
}


