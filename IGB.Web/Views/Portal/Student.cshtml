@{
    ViewData["Title"] = "Dashboard";
    
    // Build action buttons
    var actionButtons = new List<IGB.Web.ViewModels.PageHeaderActionButton>();
    actionButtons.Add(new IGB.Web.ViewModels.PageHeaderActionButton(
        Text: "Profile",
        Url: Url.Action("Index", "Profile"),
        Icon: "fas fa-user-circle me-1",
        ButtonType: "outline-secondary"
    ));
    
    // Build page header
    var pageHeader = new IGB.Web.ViewModels.PageHeaderViewModel(
        Title: "Dashboard",
        Icon: "fas fa-tachometer-alt",
        Breadcrumbs: new List<BreadcrumbItem> { new("Dashboard", Url.Action("Index", "Portal")) },
        ActionButtons: actionButtons
    );
}

<partial name="_PageHeader" model="pageHeader" />

<div class="container-fluid">
    <style>
        .skeleton {
            background: linear-gradient(90deg, rgba(0,0,0,0.06) 25%, rgba(0,0,0,0.12) 37%, rgba(0,0,0,0.06) 63%);
            background-size: 400% 100%;
            animation: shimmer 1.2s ease-in-out infinite;
            border-radius: 12px;
        }
        @@keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }
        
        /* Professional card styling */
        #widgets .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        #widgets .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        #widgets .card-body {
            padding: 1.5rem;
        }
        
        .pulse {
            animation: pulse 1.4s ease-in-out infinite;
        }
        @@keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(25,135,84,0.25); }
            70% { box-shadow: 0 0 0 10px rgba(25,135,84,0); }
            100% { box-shadow: 0 0 0 0 rgba(25,135,84,0); }
        }
        
        .lesson-border-upcoming { border-left: 4px solid #0dcaf0; }
        .lesson-border-ongoing { border-left: 4px solid #198754; }
        .lesson-border-completed { border-left: 4px solid #6c757d; }
        .lesson-border-cancelled { border-left: 4px solid #dc3545; }
        
        /* Quick action cards */
        #widgets a.card {
            transition: all 0.3s ease;
            border: 1px solid rgba(13,110,253,0.2) !important;
            border-radius: 12px !important;
        }
        #widgets a.card:hover {
            border-color: rgba(13,110,253,0.4) !important;
            box-shadow: 0 4px 12px rgba(13,110,253,0.15);
            transform: translateY(-2px);
        }
    </style>

    <div id="errorBox" class="alert alert-danger d-none">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-semibold">Dashboard failed to load</div>
                <div class="small text-muted">Please retry.</div>
            </div>
            <button class="btn btn-sm btn-light" id="retryBtn">Retry</button>
        </div>
    </div>


    <div id="widgets" class="row g-3">
        <!-- Stats (4) -->
        <div class="col-12" data-widget="stats">
            <div class="overview-stats-section">
                <div class="row g-3">
                    <div class="col-xl-3 col-md-6">
                        <a href="/CourseBookings/My" class="text-decoration-none">
                            <div class="kpi-tile kpi-tile-blue">
                                <div class="kpi-icon"><i class="fas fa-book"></i></div>
                                <div class="kpi-body">
                                    <div class="kpi-value" id="cardCourses">â€”</div>
                                    <div class="kpi-label">Enrolled Courses</div>
                                    <div class="kpi-sub"><span id="cardCoursesCompleted">0</span> completed</div>
                                    <div class="kpi-accent"></div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <a href="/Credits/My" class="text-decoration-none">
                            <div class="kpi-tile kpi-tile-green" id="creditsCard">
                                <div class="kpi-icon"><i class="fas fa-coins"></i></div>
                                <div class="kpi-body">
                                    <div class="kpi-value" id="cardCredits">â€”</div>
                                    <div class="kpi-label">Available Credits</div>
                                    <div class="kpi-sub" id="creditWarning">Healthy balance</div>
                                    <div class="kpi-accent"></div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <a href="/Schedule/My" class="text-decoration-none">
                            <div class="kpi-tile kpi-tile-amber">
                                <div class="kpi-icon"><i class="fas fa-calendar-alt"></i></div>
                                <div class="kpi-body">
                                    <div class="kpi-value" id="cardWeekLessons">â€”</div>
                                    <div class="kpi-label">Lessons This Week</div>
                                    <div class="kpi-sub" id="nextLesson">Next: â€”</div>
                                    <div class="kpi-accent"></div>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <a href="/Progress/My" class="text-decoration-none">
                            <div class="kpi-tile kpi-tile-red">
                                <div class="kpi-icon"><i class="fas fa-chart-pie"></i></div>
                                <div class="kpi-body">
                                    <div class="kpi-value" id="overallPct">â€”</div>
                                    <div class="kpi-label">Overall Progress</div>
                                    <div class="kpi-sub">Across all courses</div>
                                    <div class="kpi-accent"></div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Schedule -->
        <div class="col-12" data-widget="schedule">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>My Schedule
                        </h6>
                        <a class="btn btn-sm btn-outline-primary" href="/Schedule/My">
                            <i class="fas fa-external-link-alt me-1"></i>View Full Schedule
                        </a>
                    </div>
                    <div id="scheduleCalendar"></div>
                </div>
            </div>
        </div>

        <!-- Quick actions -->
        <div class="col-12" data-widget="actions">
            <div class="card">
                <div class="card-body">
                    <h6 class="mb-2">Quick actions</h6>
                    <div class="row g-2">
                        <div class="col-12 col-md-6 col-xl-4">
                            <a class="card p-3 text-decoration-none h-100" href="/LessonBookings/Create" style="border:1px solid rgba(13,110,253,0.25);">
                                <div class="icon-circle"><i class="fas fa-book-open"></i></div>
                                <div class="fw-semibold mt-2">Book a Lesson</div>
                                <div class="text-muted small">Schedule your next class</div>
                            </a>
                        </div>
                        <div class="col-12 col-md-6 col-xl-4">
                            <a class="card p-3 text-decoration-none h-100" href="/Courses/Browse" style="border:1px solid rgba(13,110,253,0.25);">
                                <div class="icon-circle"><i class="fas fa-search"></i></div>
                                <div class="fw-semibold mt-2">Browse Courses</div>
                                <div class="text-muted small">Explore available courses</div>
                            </a>
                        </div>
                        <div class="col-12 col-md-6 col-xl-4">
                            <a class="card p-3 text-decoration-none h-100" href="/Schedule/My" style="border:1px solid rgba(13,110,253,0.25);">
                                <div class="icon-circle"><i class="fas fa-calendar-alt"></i></div>
                                <div class="fw-semibold mt-2">My Schedule</div>
                                <div class="text-muted small">View upcoming lessons</div>
                            </a>
                        </div>
                        <div class="col-12 col-md-6 col-xl-4">
                            <a class="card p-3 text-decoration-none h-100" href="/Credits/My" id="purchaseCreditsBtn" style="border:1px solid rgba(13,110,253,0.25);">
                                <div class="d-flex justify-content-between">
                                    <div class="icon-circle"><i class="fas fa-credit-card"></i></div>
                                    <span class="badge bg-danger d-none" id="lowCreditBadge">Low!</span>
                                </div>
                                <div class="fw-semibold mt-2">Credits</div>
                                <div class="text-muted small">Manage your credits</div>
                            </a>
                        </div>
                        <div class="col-12 col-md-6 col-xl-4">
                            <a class="card p-3 text-decoration-none h-100" href="/Progress/My" style="border:1px solid rgba(13,110,253,0.25);">
                                <div class="icon-circle"><i class="fas fa-chart-line"></i></div>
                                <div class="fw-semibold mt-2">My Progress</div>
                                <div class="text-muted small">Track your learning</div>
                            </a>
                        </div>
                        <div class="col-12 col-md-6 col-xl-4">
                            <a class="card p-3 text-decoration-none h-100" href="/Feedback/My" style="border:1px solid rgba(13,110,253,0.25);">
                                <div class="d-flex justify-content-between">
                                    <div class="icon-circle"><i class="fas fa-star"></i></div>
                                    <span class="badge bg-primary d-none" id="pendingFeedbackBadge">0</span>
                                </div>
                                <div class="fw-semibold mt-2">Give Feedback</div>
                                <div class="text-muted small">Rate your lessons</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Courses (Recent) -->
        <div class="col-12" data-widget="courses">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                        <div class="d-flex align-items-center gap-2">
                            <h6 class="mb-0">Recent Course Bookings</h6>
                            <span class="badge bg-light text-dark" id="coursesTotalBadge">0</span>
                        </div>
                        <a class="small text-decoration-none" href="/CourseBookings/My">View All</a>
                    </div>
                    <div class="row g-3" id="courseGrid">
                        <div class="col-12 col-md-6 col-xl-4">
                            <div class="card"><div class="card-body"><div class="skeleton" style="height:140px;"></div></div></div>
                        </div>
                    </div>
                    <div class="text-muted d-none" id="coursesEmpty">No recent course bookings.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lesson Details Modal -->
<div class="modal fade" id="lessonDetailsModal" tabindex="-1" aria-labelledby="lessonDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lessonDetailsModalLabel">
                    <i class="fas fa-calendar-check me-2"></i><span id="lessonModalTitle">Lesson Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-book text-primary me-2"></i>
                            <div>
                                <div class="text-muted small">Course / Subject</div>
                                <div class="fw-semibold" id="lessonModalCourse">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-user-tie text-info me-2"></i>
                            <div>
                                <div class="text-muted small">Tutor / Teacher</div>
                                <div class="fw-semibold" id="lessonModalTutor">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <div>
                                <div class="text-muted small">Time</div>
                                <div class="fw-semibold" id="lessonModalTime">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-info-circle text-secondary me-2"></i>
                            <div>
                                <div class="text-muted small">Status</div>
                                <div>
                                    <span class="badge" id="lessonModalStatusBadge">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12" id="lessonModalZoom" style="display: none;">
                        <hr />
                        <h6 class="mb-3"><i class="fas fa-video me-2"></i>Zoom Meeting</h6>
                        <div class="mb-2">
                            <div class="text-muted small">Meeting ID</div>
                            <div class="fw-semibold" id="lessonModalMeetingId">-</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-muted small">Password</div>
                            <div class="fw-semibold" id="lessonModalPassword">-</div>
                        </div>
                        <button type="button" class="btn btn-success w-100" id="lessonModalJoinBtn" style="display: none;">
                            <i class="fas fa-video me-2"></i>Join Zoom Meeting
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
       @*          <a class="btn btn-outline-primary" id="lessonModalViewDetails" href="#" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>View Full Details
                </a> *@
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<link href="/nobleui/vendors/fullcalendar/main.min.css" rel="stylesheet" />
<style>
    /* Professional Calendar Styling */
    #scheduleCalendar {
        font-family: inherit;
    }
    
    #scheduleCalendar .fc {
        background: #fff;
        border-radius: 8px;
    }
    
    #scheduleCalendar .fc-toolbar-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #212529;
    }
    
    #scheduleCalendar .fc-button {
        background-color: #fff;
        border: 1px solid #dee2e6;
        color: #495057;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    #scheduleCalendar .fc-button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
        color: #212529;
    }
    
    #scheduleCalendar .fc-button-active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
    
    #scheduleCalendar .fc-daygrid-day {
        border-color: #e9ecef;
    }
    
    #scheduleCalendar .fc-col-header-cell {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        padding: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        color: #495057;
    }
    
    #scheduleCalendar .fc-timegrid-slot {
        border-color: #f1f3f5;
        height: 2.5rem;
    }
    
    #scheduleCalendar .fc-timegrid-event {
        border-radius: 4px;
        padding: 8px 10px !important;
        min-height: 70px !important;
        overflow: visible !important;
    }
    
    #scheduleCalendar .fc-event {
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    #scheduleCalendar .fc-event:hover {
        opacity: 0.9;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        transform: translateY(-1px);
    }
    
    #scheduleCalendar .fc-day-today {
        background-color: #fffbf0;
    }
    
    /* Month view styling */
    #scheduleCalendar .fc-daygrid-event { 
        padding: 2px 4px; 
    }
    
    #scheduleCalendar .fc-daygrid-event .fc-event-title { 
        font-size: 0.85rem; 
        line-height: 1.3; 
    }
</style>

@section Scripts {
    <script src="/nobleui/vendors/fullcalendar/main.min.js"></script>
    <script>
        (function(){
            const state = { data: null, courseTab: 'active', calendar: null };


            const errorBox = document.getElementById('errorBox');
            const retryBtn = document.getElementById('retryBtn');

            function showError(on){
                errorBox.classList.toggle('d-none', !on);
            }

            function fmtLocal(iso){
                if (!iso) return 'â€”';
                return new Date(iso).toLocaleString([], { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
            }

            function fmtTime(iso){
                if (!iso) return 'â€”';
                return new Date(iso).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
            }

            function relStart(iso){
                const start = new Date(iso).getTime();
                const mins = Math.round((start - Date.now())/60000);
                if (mins < 0) return 'Started';
                if (mins === 0) return 'Starts now';
                if (mins < 60) return `Starts in ${mins} mins`;
                const hrs = Math.floor(mins/60);
                return `Starts in ${hrs} hours`;
            }

            function statusBadge(status, canJoin){
                const s = status || '';
                if (canJoin) return '<span class="badge bg-success pulse">In Progress</span>';
                if (s === 'Completed') return '<span class="badge bg-secondary">Completed</span>';
                if (s === 'Cancelled') return '<span class="badge bg-danger">Cancelled</span>';
                if (s === 'Scheduled' || s === 'Rescheduled') return '<span class="badge bg-info text-dark">Upcoming</span>';
                return `<span class="badge bg-light text-dark">${s}</span>`;
            }

            function leftBorder(status, canJoin){
                if (canJoin) return 'lesson-border-ongoing';
                if (status === 'Completed') return 'lesson-border-completed';
                if (status === 'Cancelled') return 'lesson-border-cancelled';
                return 'lesson-border-upcoming';
            }

            function renderOverview(){
                const d = state.data;
                document.getElementById('cardCourses').textContent = d.overview?.courses?.enrolledCount ?? 0;
                document.getElementById('cardCoursesCompleted').textContent = d.overview?.courses?.completedCount ?? 0;

                const credits = d.overview?.credits;
                const remaining = credits?.remaining ?? 0;
                document.getElementById('cardCredits').textContent = remaining;

                // low credit styling
                const creditsCard = document.getElementById('creditsCard');
                creditsCard.classList.toggle('kpi-tile-green', !(credits?.isLow));
                creditsCard.classList.toggle('kpi-tile-amber', !!(credits?.isLow));
                document.getElementById('lowCreditBadge').classList.toggle('d-none', !(credits?.isLow));
                document.getElementById('creditWarning').textContent = (credits?.isLow) ? 'Low balance!' : 'Healthy balance';

                document.getElementById('cardWeekLessons').textContent = d.overview?.lessonsThisWeek?.count ?? 0;
                document.getElementById('nextLesson').textContent = d.overview?.lessonsThisWeek?.nextLessonStartUtc ? `Next: ${fmtLocal(d.overview.lessonsThisWeek.nextLessonStartUtc)}` : 'Next: â€”';

                // pending feedback badge
                const pending = d.quick?.pendingFeedbackCount ?? 0;
                const pb = document.getElementById('pendingFeedbackBadge');
                pb.textContent = pending;
                pb.classList.toggle('d-none', pending <= 0);

                // overall progress
                const pct = d.overview?.overallProgress?.percent ?? 0;
                document.getElementById('overallPct').textContent = `${pct}%`;
            }

            function renderSchedule(){
                // Initialize calendar if not already done
                if (!state.calendar) {
                    initCalendar();
                } else {
                    state.calendar.refetchEvents();
                }
            }

            function renderCourses(){
                const grid = document.getElementById('courseGrid');
                const empty = document.getElementById('coursesEmpty');
                const badge = document.getElementById('coursesTotalBadge');
                const items = (state.data?.courses?.items || []);

                // Show only recent course bookings (limit to 6 most recent)
                // The API returns courses ordered by most recent bookings first
                const recent = items.slice(0, 6);

                badge.textContent = `${recent.length} recent`;
                empty.classList.toggle('d-none', recent.length !== 0);
                if (!recent.length) { grid.innerHTML = ''; return; }

                grid.innerHTML = recent.map(c => {
                    const img = c.imageUrl ? `<div style="height:120px;background:#f8f9fa url('${c.imageUrl}') center/cover no-repeat;border-radius:10px;"></div>` : `<div style="height:120px;background:#f8f9fa;border-radius:10px;"></div>`;
                    const pct = c.progressPercent || 0;
                    const barClass = pct >= 70 ? 'bg-success' : (pct >= 40 ? 'bg-warning' : 'bg-danger');
                    return `
                      <div class="col-12 col-md-6 col-xl-4">
                        <div class="card h-100">
                          <div class="card-body">
                            ${img}
                            <div class="d-flex justify-content-between align-items-center mt-2">
                              <span class="badge bg-light text-dark">${c.curriculum} â€¢ ${c.grade}</span>
                              <a class="small text-decoration-none" href="/Courses/Edit?id=${c.courseId}">Open</a>
                            </div>
                            <div class="fw-semibold mt-2 fs-5">${c.courseName}</div>
                            <div class="text-muted small mt-1"><i class="fas fa-chalkboard-teacher me-1"></i>${c.tutorName}</div>
                            <div class="mt-2">
                              <div class="d-flex justify-content-between small">
                                <span class="text-muted">${pct}% Complete</span>
                                <span class="text-muted">${c.coveredTopics} of ${c.totalTopics} topics</span>
                              </div>
                              <div class="progress mt-1" style="height:8px;">
                                <div class="progress-bar ${barClass}" style="width:${pct}%"></div>
                              </div>
                            </div>
                            <div class="d-flex gap-2 mt-3 flex-wrap">
                              <a class="btn btn-sm btn-outline-primary" href="/Schedule/My?courseId=${c.courseId}">Schedule</a>
                              <a class="btn btn-sm btn-outline-secondary" href="/TestReports/My?courseId=${c.courseId}">Tests</a>
                            </div>
                          </div>
                        </div>
                      </div>`;
                }).join('');
            }

            async function load(){
                showError(false);
                try{
                    const res = await fetch('/api/student/dashboard', { credentials: 'include' });
                    if (!res.ok) throw new Error('bad response');
                    state.data = await res.json();
                    renderOverview();
                    renderSchedule();
                    renderCourses();
                }catch(e){
                    console.error(e);
                    showError(true);
                }
            }

            retryBtn.addEventListener('click', () => load());

            function fmtDateTime(isoUtc) {
                if (!isoUtc) return "";
                const d = new Date(isoUtc);
                const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                return new Intl.DateTimeFormat(undefined, opts).format(d);
            }

            function initCalendar() {
                const el = document.getElementById('scheduleCalendar');
                if (!el || typeof FullCalendar === 'undefined') return;

                const url = '/Schedule/Events?scope=student';

                function esc(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
                
                function applyRichTitle(info){
                    const el = info?.el;
                    const ev = info?.event;
                    if (!el || !ev) return;
                    const p = ev.extendedProps || {};
                    const course = p.courseName || ev.title || '';
                    const teacher = p.tutorName || '';
                    const view = info.view.type;
                    
                    const titleEl = el.querySelector('.fc-event-title, .fc-title');
                    if (!titleEl) return;

                    if (view === 'dayGridMonth') {
                        const parts = [`<div class="fw-semibold">${esc(course)}</div>`];
                        if (teacher) parts.push(`<div class="small text-muted">ðŸ‘¤ ${esc(teacher)}</div>`);
                        titleEl.innerHTML = parts.join('');
                    } else {
                        const startTime = ev.start ? new Date(ev.start).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';
                        const endTime = ev.end ? new Date(ev.end).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : '';
                        
                        const parts = [
                            `<div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 6px; color: inherit; line-height: 1.3;">${esc(course)}</div>`,
                            `<div style="font-size: 0.875rem; margin-bottom: 4px; opacity: 0.95; line-height: 1.4;"><i class="fas fa-user-tie" style="width: 14px; display: inline-block;"></i> ${esc(teacher || 'N/A')}</div>`,
                            `<div style="font-size: 0.8rem; opacity: 0.9; line-height: 1.3;"><i class="fas fa-clock" style="width: 14px; display: inline-block;"></i> ${startTime} - ${endTime}</div>`
                        ];
                        titleEl.innerHTML = parts.join('');
                        titleEl.style.whiteSpace = 'normal';
                        titleEl.style.overflow = 'visible';
                        titleEl.style.height = 'auto';
                        titleEl.style.lineHeight = '1.5';
                    }
                }

                state.calendar = new FullCalendar.Calendar(el, {
                    initialView: 'dayGridMonth',
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                    height: 'auto',
                    expandRows: true,
                    nowIndicator: true,
                    timeZone: 'UTC',
                    slotMinTime: '00:00:00',
                    slotMaxTime: '24:00:00',
                    slotDuration: '00:30:00',
                    slotLabelInterval: '01:00:00',
                    eventMinHeight: 70,
                    eventDidMount: applyRichTitle,
                    eventRender: applyRichTitle,
                    events: async (info, success) => {
                        try {
                            const res = await fetch(url, { credentials: 'include' });
                            if (!res.ok) throw new Error('Failed to load events');
                            const data = await res.json();
                            success(data.map(e => ({
                                id: e.id,
                                title: e.title,
                                start: e.start,
                                end: e.end,
                                color: e.color,
                                extendedProps: {
                                    status: e.status,
                                    joinUrl: e.joinUrl,
                                    canJoin: e.canJoin,
                                    zoomMeetingId: e.zoomMeetingId,
                                    zoomPassword: e.zoomPassword,
                                    courseName: e.courseName,
                                    tutorName: e.tutorName
                                }
                            })));
                        } catch (error) {
                            console.error('Error loading calendar events:', error);
                            success([]);
                        }
                    },
                    eventClick: (info) => {
                        info.jsEvent.preventDefault();
                        const ev = info.event;
                        const p = ev.extendedProps || {};
                        const start = fmtDateTime(ev.start);
                        const end = fmtTime(ev.end);
                        
                        // Populate modal
                        const modalTitle = document.getElementById('lessonModalTitle');
                        const modalCourse = document.getElementById('lessonModalCourse');
                        const modalTutor = document.getElementById('lessonModalTutor');
                        const modalTime = document.getElementById('lessonModalTime');
                        const statusBadge = document.getElementById('lessonModalStatusBadge');
                        // const viewDetailsLink = document.getElementById('lessonModalViewDetails');
                        
                        if (modalTitle) modalTitle.textContent = p.courseName || 'Lesson Details';
                        if (modalCourse) modalCourse.textContent = p.courseName || 'N/A';
                        if (modalTutor) modalTutor.textContent = p.tutorName || 'N/A';
                        if (modalTime) modalTime.textContent = `${start} - ${end}`;
                        // if (viewDetailsLink && ev.id) {
                        //     viewDetailsLink.href = `/LessonBookings/Details?id=${ev.id}`;
                        //     viewDetailsLink.style.display = 'inline-block';
                        // }
                        
                        // Status badge
                        if (statusBadge) {
                            const status = (p.status || '').toLowerCase();
                            statusBadge.className = 'badge ';
                            if (status.includes('completed')) statusBadge.className += 'bg-success';
                            else if (status.includes('cancelled') || status.includes('rejected')) statusBadge.className += 'bg-secondary';
                            else if (status.includes('scheduled') || status.includes('rescheduled')) statusBadge.className += 'bg-primary';
                            else statusBadge.className += 'bg-warning';
                            statusBadge.textContent = p.status || 'N/A';
                        }
                        
                        // Zoom info
                        const zoomSection = document.getElementById('lessonModalZoom');
                        if (zoomSection) {
                            if (p.zoomMeetingId || p.joinUrl) {
                                zoomSection.style.display = 'block';
                                const meetingId = document.getElementById('lessonModalMeetingId');
                                const password = document.getElementById('lessonModalPassword');
                                const joinBtn = document.getElementById('lessonModalJoinBtn');
                                
                                if (meetingId) meetingId.textContent = p.zoomMeetingId || 'N/A';
                                if (password) password.textContent = p.zoomPassword || 'N/A';
                                
                                if (joinBtn) {
                                    if (p.canJoin && p.joinUrl) {
                                        joinBtn.style.display = 'inline-block';
                                        joinBtn.onclick = () => window.open(p.joinUrl, '_blank');
                                    } else {
                                        joinBtn.style.display = 'none';
                                    }
                                }
                            } else {
                                zoomSection.style.display = 'none';
                            }
                        }
                        
                        // Show modal
                        const modalEl = document.getElementById('lessonDetailsModal');
                        if (modalEl) {
                            const modal = new bootstrap.Modal(modalEl);
                            modal.show();
                        }
                    }
                });

                state.calendar.render();
            }


            // notification hook (refresh dashboard after relevant events)
            window.igbStudentDashboard = {
                onNotify: () => { load(); }
            };

            load();
        })();
    </script>
}


