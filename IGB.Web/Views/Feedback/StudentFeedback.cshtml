@model IGB.Web.ViewModels.Feedback.AdminStudentFeedbackPageViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Student Feedback";
    var csrf = Antiforgery.GetAndStoreTokens(Context).RequestToken;
    var courses = ViewBag.Courses as System.Collections.IEnumerable;
    
    // Build search
    var search = new IGB.Web.ViewModels.PageHeaderSearch(
        Placeholder: "Search by course, student, teacher, or comments...",
        QueryParamName: "q",
        CurrentValue: Model.Query,
        FormAction: Url.Action("StudentFeedback", "Feedback"),
        ShowClearButton: false
    );
    
    // Build filters
    var courseOptions = new Dictionary<string, string> { { "", "All Courses" } };
    if (courses != null)
    {
        foreach (dynamic c in courses)
        {
            courseOptions.Add(c.Id.ToString(), c.Name);
        }
    }
    
    var ratingOptions = new Dictionary<string, string> { { "", "Any Rating" } };
    for (var i = 5; i >= 1; i--)
    {
        ratingOptions.Add(i.ToString(), i.ToString());
    }
    
    var flaggedOptions = new Dictionary<string, string>
    {
        { "", "Any Status" },
        { "true", "Flagged" },
        { "false", "Not Flagged" }
    };
    
    var filters = new List<PageHeaderFilter>
    {
        new("Course", "courseId", "select", Model.CourseId?.ToString() ?? "", courseOptions),
        new("Rating", "rating", "select", Model.Rating?.ToString() ?? "", ratingOptions),
        new("Flagged", "flagged", "select", Model.Flagged?.ToString() ?? "", flaggedOptions)
    };
    
    // Build action buttons - Clear Filters button if any filters are active
    var hasActiveFilters = Model.CourseId.HasValue || Model.Rating.HasValue || Model.Flagged.HasValue || !string.IsNullOrWhiteSpace(Model.Query);
    var actionButtons = new List<PageHeaderActionButton>();
    if (hasActiveFilters)
    {
        actionButtons.Add(new PageHeaderActionButton(
            "Clear Filters",
            Url.Action("StudentFeedback", "Feedback"),
            Icon: "fas fa-times me-1",
            ButtonType: "outline-secondary"
        ));
    }
    
    // Build page header
    var pageHeader = new IGB.Web.ViewModels.PageHeaderViewModel(
        Title: "Student Feedback",
        Icon: "fas fa-user-graduate",
        Breadcrumbs: new List<BreadcrumbItem>
        {
            new("Dashboard", Url.Action("Index", "Home")),
            new("Feedback"),
            new("Student Feedback")
        },
        Subtitle: "View and manage feedback from teachers to students",
        Search: search,
        Filters: filters,
        ActionButtons: actionButtons.Count > 0 ? actionButtons : null
    );
}

@await Html.PartialAsync("_PageHeader", pageHeader)

<div class="container-fluid">
    @if (TempData["Success"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Success"]!.ToString()!, Variant: "success", Dismissible: true))" />
    }

    @{
        var table = new IGB.Web.ViewModels.Components.TableShellViewModel(
            Id: "student-feedback-table",
            Title: "Feedback (Teacher → Student)",
            Columns: new List<IGB.Web.ViewModels.Components.TableColumn>
            {
                new("Date"),
                new("Rating"),
                new("Teacher"),
                new("Student"),
                new("Course"),
                new("Files"),
                new("Flagged"),
                new("Actions")
            },
            SearchQuery: null, // Search is in page header, not in table
            RenderRows: html =>
            {
                var rows = new System.Text.StringBuilder();
                foreach (var r in Model.Items)
                {
                    rows.AppendLine("<tr>");
                    rows.AppendLine($"<td class=\"text-muted small\">{r.CreatedAtUtc:yyyy-MM-dd}</td>");
                    rows.AppendLine("<td class=\"text-nowrap\">");
                    rows.AppendLine($"<span class=\"fw-semibold\">{r.Rating}/5</span>");
                    rows.AppendLine("<span class=\"ms-1 text-warning\">");
                    for (var i = 1; i <= 5; i++)
                    {
                        if (r.Rating >= i)
                        {
                            rows.AppendLine("<i class=\"fas fa-star\"></i>");
                        }
                        else
                        {
                            rows.AppendLine("<i class=\"far fa-star\"></i>");
                        }
                    }
                    rows.AppendLine("</span>");
                    rows.AppendLine("</td>");
                    rows.AppendLine($"<td>{System.Net.WebUtility.HtmlEncode(r.TutorName)}</td>");
                    rows.AppendLine($"<td>{System.Net.WebUtility.HtmlEncode(r.StudentName)}</td>");
                    rows.AppendLine($"<td class=\"text-muted\">{System.Net.WebUtility.HtmlEncode(r.CourseName)}</td>");
                    rows.AppendLine($"<td class=\"text-muted\">{r.AttachmentCount}</td>");
                    rows.AppendLine("<td>");
                    rows.AppendLine(r.IsFlagged
                        ? "<span class=\"badge bg-danger\">Yes</span>"
                        : "<span class=\"badge bg-success\">No</span>");
                    rows.AppendLine("</td>");
                    rows.AppendLine("<td class=\"text-nowrap\">");
                    if (!r.IsFlagged)
                    {
                        rows.AppendLine($"<form method=\"post\" action=\"{Url.Action("FlagStudentFeedback","Feedback")}\" class=\"d-inline\">");
                        rows.AppendLine($"<input name=\"__RequestVerificationToken\" type=\"hidden\" value=\"{csrf}\" />");
                        rows.AppendLine($"<input type=\"hidden\" name=\"id\" value=\"{r.FeedbackId}\" />");
                        rows.AppendLine($"<input type=\"hidden\" name=\"reason\" value=\"Flagged by admin\" />");
                        rows.AppendLine("<button class=\"btn btn-sm btn-outline-danger\" type=\"submit\">Flag</button>");
                        rows.AppendLine("</form>");
                    }
                    else
                    {
                        rows.AppendLine("<span class=\"text-muted\">—</span>");
                    }
                    rows.AppendLine("</td>");
                    rows.AppendLine("</tr>");
                }
                return new Microsoft.AspNetCore.Html.HtmlString(rows.ToString());
            },
            Pagination: Model.Pagination
        );
    }

    <partial name="Components/_TableShell" model="table" />
</div>


