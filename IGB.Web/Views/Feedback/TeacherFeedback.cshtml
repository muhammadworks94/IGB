@model IGB.Web.ViewModels.Feedback.AdminTeacherFeedbackPageViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Teacher Feedback";
    var csrf = Antiforgery.GetAndStoreTokens(Context).RequestToken;
    var courses = ViewBag.Courses as System.Collections.IEnumerable;
    
    // Build search
    var search = new IGB.Web.ViewModels.PageHeaderSearch(
        Placeholder: "Search by course, student, teacher, or comments...",
        QueryParamName: "q",
        CurrentValue: Model.Query,
        FormAction: Url.Action("TeacherFeedback", "Feedback"),
        ShowClearButton: true,
        ClearButtonUrl: Url.Action("TeacherFeedback", "Feedback", new { courseId = Model.CourseId, rating = Model.Rating, flagged = Model.Flagged })
    );
    
    // Build page header
    var pageHeader = new IGB.Web.ViewModels.PageHeaderViewModel(
        Title: "Teacher Feedback",
        Breadcrumbs: new List<BreadcrumbItem>
        {
            new("Dashboard", Url.Action("Index", "Home")),
            new("Feedback"),
            new("Teacher Feedback")
        },
        Subtitle: "View and manage feedback from students to teachers",
        Search: search
    );
}

<partial name="_PageHeader" model="pageHeader" />

<div class="container-fluid">
    @if (TempData["Success"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Success"]!.ToString()!, Variant: "success", Dismissible: true))" />
    }

    <!-- Filters Card -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <input type="hidden" name="q" value="@Model.Query" />
                <div class="col-md-4">
                    <label class="form-label small">Course</label>
                    <select class="form-select form-select-sm" name="courseId" onchange="this.form.submit()">
                        <option value="">All</option>
                        @if (courses != null)
                        {
                            foreach (dynamic c in courses)
                            {
                                var selected = (Model.CourseId.HasValue && ((long)c.Id) == Model.CourseId.Value);
                                <option value="@c.Id" selected="@selected">@c.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Rating</label>
                    <select class="form-select form-select-sm" name="rating" onchange="this.form.submit()">
                        <option value="">Any</option>
                        @for (var i = 5; i >= 1; i--)
                        {
                            <option value="@i" selected="@(Model.Rating == i)">@i</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Flagged</label>
                    <select class="form-select form-select-sm" name="flagged" onchange="this.form.submit()">
                        <option value="">Any</option>
                        <option value="true" selected="@(Model.Flagged == true)">Flagged</option>
                        <option value="false" selected="@(Model.Flagged == false)">Not flagged</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <a class="btn btn-outline-secondary btn-sm w-100" href="@Url.Action("TeacherFeedback","Feedback")">
                        <i class="fas fa-times me-1"></i>Clear Filters
                    </a>
                </div>
            </form>
        </div>
    </div>

    @{
        var table = new IGB.Web.ViewModels.Components.TableShellViewModel(
            Id: "teacher-feedback-table",
            Title: "Feedback (Student â†’ Teacher)",
            Columns: new List<IGB.Web.ViewModels.Components.TableColumn>
            {
                new("Date"),
                new("Rating"),
                new("Student"),
                new("Teacher"),
                new("Course"),
                new("Flagged"),
                new("Actions")
            },
            SearchQuery: null, // Search is in page header, not in table
            RenderRows: html =>
            {
                var rows = new System.Text.StringBuilder();
                foreach (var r in Model.Items)
                {
                    rows.AppendLine("<tr>");
                    rows.AppendLine($"<td class=\"text-muted small\">{r.CreatedAtUtc:yyyy-MM-dd}</td>");
                    rows.AppendLine("<td class=\"text-nowrap\">");
                    rows.AppendLine($"<span class=\"fw-semibold\">{r.Rating}/5</span>");
                    rows.AppendLine("<span class=\"ms-1 text-warning\">");
                    for (var i = 1; i <= 5; i++)
                    {
                        if (r.Rating >= i)
                        {
                            rows.AppendLine("<i class=\"fas fa-star\"></i>");
                        }
                        else
                        {
                            rows.AppendLine("<i class=\"far fa-star\"></i>");
                        }
                    }
                    rows.AppendLine("</span>");
                    rows.AppendLine("</td>");
                    rows.AppendLine($"<td>{System.Net.WebUtility.HtmlEncode(r.StudentName)}</td>");
                    rows.AppendLine($"<td>{System.Net.WebUtility.HtmlEncode(r.TutorName)}</td>");
                    rows.AppendLine($"<td class=\"text-muted\">{System.Net.WebUtility.HtmlEncode(r.CourseName)}</td>");
                    rows.AppendLine("<td>");
                    rows.AppendLine(r.IsFlagged
                        ? "<span class=\"badge bg-danger\">Yes</span>"
                        : "<span class=\"badge bg-success\">No</span>");
                    rows.AppendLine("</td>");
                    rows.AppendLine("<td class=\"text-nowrap\">");
                    rows.AppendLine($"<a class=\"btn btn-sm btn-outline-secondary\" href=\"{Url.Action("TutorReview", "Feedback", new { lessonId = r.LessonId })}\">Details</a>");
                    if (!r.IsFlagged)
                    {
                        rows.AppendLine($"<form method=\"post\" action=\"{Url.Action("FlagTutorFeedback","Feedback")}\" class=\"d-inline ms-1\">");
                        rows.AppendLine($"<input name=\"__RequestVerificationToken\" type=\"hidden\" value=\"{csrf}\" />");
                        rows.AppendLine($"<input type=\"hidden\" name=\"id\" value=\"{r.FeedbackId}\" />");
                        rows.AppendLine($"<input type=\"hidden\" name=\"reason\" value=\"Flagged by admin\" />");
                        rows.AppendLine("<button class=\"btn btn-sm btn-outline-danger\" type=\"submit\">Flag</button>");
                        rows.AppendLine("</form>");
                    }
                    rows.AppendLine("</td>");
                    rows.AppendLine("</tr>");
                }
                return new Microsoft.AspNetCore.Html.HtmlString(rows.ToString());
            },
            Pagination: Model.Pagination
        );
    }

    <partial name="Components/_TableShell" model="table" />
</div>


