@model IGB.Web.ViewModels.Tutor.TutorAvailabilityPageViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Availability";
    var csrf = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: "Availability",
    Icon: "fas fa-clock",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Dashboard", Url.Action("Index", "Home")),
        new("My Schedule"),
        new("Availability")
    },
    Subtitle: $"Timezone: {Model.TutorTimeZoneId}"
))

<div class="container-fluid">
   @*  @if (TempData["Error"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Error"]!.ToString()!, Variant: "danger", Dismissible: true))" />
    }
    @if (TempData["Success"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Success"]!.ToString()!, Variant: "success", Dismissible: true))" />
    } *@

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Weekly Availability Rules</h5>
                    <form method="post" asp-action="SaveRule" class="row g-2">
                        @Html.AntiForgeryToken()
                        <div class="col-md-3">
                            <label class="form-label">Day</label>
                            <select class="form-select" name="DayOfWeek">
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                                <option value="0">Sunday</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Start</label>
                            <input class="form-control" type="time" id="ruleStart" value="09:00" />
                            <input type="hidden" name="StartMinutes" id="ruleStartMinutes" value="540" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">End</label>
                            <input class="form-control" type="time" id="ruleEnd" value="17:00" />
                            <input type="hidden" name="EndMinutes" id="ruleEndMinutes" value="1020" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Slot</label>
                            <select class="form-select" name="SlotMinutes">
                                <option value="30">30m</option>
                                <option value="45">45m</option>
                                <option value="60" selected>60m</option>
                            </select>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button class="btn btn-primary w-100" type="submit">Add</button>
                        </div>
                    </form>

                    <hr />

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th>Day</th>
                                <th>Range</th>
                                <th>Slot</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var r in Model.Rules)
                            {
                                string DayName(int d) => Enum.GetName(typeof(DayOfWeek), d) ?? d.ToString();
                                string ToTime(int mins) => $"{mins / 60:00}:{mins % 60:00}";
                                <tr>
                                    <td>@DayName(r.DayOfWeek)</td>
                                    <td>@ToTime(r.StartMinutes) - @ToTime(r.EndMinutes)</td>
                                    <td>@r.SlotMinutes min</td>
                                    <td>
                                        <span class="badge @(r.IsActive ? "bg-success" : "bg-secondary")">@(r.IsActive ? "Active" : "Inactive")</span>
                                    </td>
                                    <td class="text-end">
                                        <form method="post" asp-action="DeleteRule" asp-route-id="@r.Id" class="d-inline" onsubmit="return confirm('Delete rule?');">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="mb-3">Blocked Dates/Times</h5>
                    <form method="post" asp-action="SaveBlock" class="row g-2">
                        @Html.AntiForgeryToken()
                        <div class="col-md-4">
                            <label class="form-label">Start (local)</label>
                            <input class="form-control" type="datetime-local" id="blockStartLocal" />
                            <input type="hidden" name="StartUtc" id="blockStartUtc" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">End (local)</label>
                            <input class="form-control" type="datetime-local" id="blockEndLocal" />
                            <input type="hidden" name="EndUtc" id="blockEndUtc" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Reason</label>
                            <input class="form-control" name="Reason" />
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button class="btn btn-primary w-100" type="submit">Add</button>
                        </div>
                    </form>

                    <hr />

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                            <tr>
                                <th>Start (UTC)</th>
                                <th>End (UTC)</th>
                                <th>Reason</th>
                                <th class="text-end">Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            @foreach (var b in Model.Blocks)
                            {
                                <tr>
                                    <td>@b.StartUtc.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@b.EndUtc.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@b.Reason</td>
                                    <td class="text-end">
                                        <form method="post" asp-action="DeleteBlock" asp-route-id="@b.Id" class="d-inline" onsubmit="return confirm('Delete block?');">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-calendar-alt me-2 text-primary"></i>Availability Calendar
                        </h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" id="calendarPrev" title="Previous Week">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="calendarToday" title="Today">
                                <i class="fas fa-calendar-day"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="calendarNext" title="Next Week">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div id="availabilityCalendar"></div>
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex flex-wrap gap-3 small">
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded" style="width: 16px; height: 16px; background-color: #d1e7dd; border: 1px solid #a3cfbb;"></div>
                                <span class="text-muted">Available</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded" style="width: 16px; height: 16px; background-color: #f8d7da; border: 1px solid #f5c2c7;"></div>
                                <span class="text-muted">Blocked</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="/nobleui/vendors/fullcalendar/main.min.css" rel="stylesheet" />
<script src="/nobleui/vendors/fullcalendar/main.min.js"></script>
<style>
    #availabilityCalendar {
        font-family: inherit;
    }
    
    /* FullCalendar Professional Styling */
    .fc {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .fc-header-toolbar {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .fc-toolbar-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #212529;
    }
    
    .fc-button {
        background-color: #fff;
        border: 1px solid #dee2e6;
        color: #495057;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .fc-button:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
        color: #212529;
    }
    
    .fc-button-active {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: #fff;
    }
    
    .fc-button-active:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    .fc-daygrid-day {
        border-color: #e9ecef;
    }
    
    .fc-col-header-cell {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        padding: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        color: #495057;
    }
    
    .fc-timegrid-slot {
        border-color: #f1f3f5;
        height: 2.5rem;
    }
    
    .fc-timegrid-slot-label {
        font-size: 0.75rem;
        color: #6c757d;
        padding: 0.25rem;
    }
    
    .fc-timegrid-now-indicator-line {
        border-color: #dc3545;
        border-width: 2px;
    }
    
    .fc-event {
        border-radius: 4px;
        padding: 2px 6px;
        font-size: 0.8rem;
        border: none;
        font-weight: 500;
    }
    
    .fc-event-title {
        padding: 0;
    }
    
    .fc-day-today {
        background-color: #fffbf0;
    }
    
    .fc-timegrid-event {
        border-radius: 4px;
        margin: 1px 2px;
    }
</style>

<script>
  // Convert time inputs to minutes
  function toMinutes(v) {
    const [h,m] = String(v||"00:00").split(":").map(Number);
    return (h*60) + (m||0);
  }
  function syncRuleTimes() {
    document.getElementById("ruleStartMinutes").value = toMinutes(document.getElementById("ruleStart").value);
    document.getElementById("ruleEndMinutes").value = toMinutes(document.getElementById("ruleEnd").value);
  }
  document.getElementById("ruleStart")?.addEventListener("change", syncRuleTimes);
  document.getElementById("ruleEnd")?.addEventListener("change", syncRuleTimes);
  syncRuleTimes();

  // Block datetime-local -> UTC ISO
  function toUtcIso(localVal) {
    if (!localVal) return "";
    const d = new Date(localVal);
    return d.toISOString();
  }
  function syncBlockTimes() {
    document.getElementById("blockStartUtc").value = toUtcIso(document.getElementById("blockStartLocal").value);
    document.getElementById("blockEndUtc").value = toUtcIso(document.getElementById("blockEndLocal").value);
  }
  document.getElementById("blockStartLocal")?.addEventListener("change", syncBlockTimes);
  document.getElementById("blockEndLocal")?.addEventListener("change", syncBlockTimes);
  syncBlockTimes();

  // Calendar preview from rules + blocks (professional rendering)
  document.addEventListener("DOMContentLoaded", function () {
    // Serialize with camelCase for JavaScript compatibility (done server-side in Razor)
    const rules = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Rules, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
    const blocks = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Blocks, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
    const calEl = document.getElementById("availabilityCalendar");
    if (!calEl || typeof FullCalendar === "undefined") return;

    let calendar = null;

    function buildEvents() {
      const events = [];
      console.log('Rules:', rules);
      
      // Render weekly rules as background events (available slots)
      rules.forEach(r => {
        // Handle both camelCase and PascalCase for backwards compatibility
        const isActive = r.isActive !== undefined ? r.isActive : r.IsActive;
        const dayOfWeek = r.dayOfWeek !== undefined ? r.dayOfWeek : r.DayOfWeek;
        const startMinutes = r.startMinutes !== undefined ? r.startMinutes : r.StartMinutes;
        const endMinutes = r.endMinutes !== undefined ? r.endMinutes : r.EndMinutes;
        const slotMinutes = r.slotMinutes !== undefined ? r.slotMinutes : r.SlotMinutes;
        
        if (!isActive) return;
        
        const startHour = Math.floor(startMinutes / 60);
        const startMin = startMinutes % 60;
        const endHour = Math.floor(endMinutes / 60);
        const endMin = endMinutes % 60;
        const start = `${String(startHour).padStart(2,'0')}:${String(startMin).padStart(2,'0')}`;
        const end = `${String(endHour).padStart(2,'0')}:${String(endMin).padStart(2,'0')}`;
        
        // FullCalendar daysOfWeek: 0=Sunday, 1=Monday, 2=Tuesday, etc.
        // C# DayOfWeek: 0=Sunday, 1=Monday, 2=Tuesday, etc. (same mapping)
        // So we can use the value directly
        let dayValue = dayOfWeek;
        
        // FullCalendar recurring event format
        // daysOfWeek: 0=Sunday, 1=Monday, 2=Tuesday, etc. (matches C# DayOfWeek)
        const event = {
          title: `${start} - ${end} (${slotMinutes}m slots)`,
          daysOfWeek: [dayValue],
          startTime: start,
          endTime: end,
          display: "background",
          backgroundColor: "#d1e7dd",
          borderColor: "#a3cfbb",
          classNames: ['availability-slot'],
          extendedProps: {
            dayOfWeek: dayValue,
            startTime: start,
            endTime: end,
            slotMinutes: slotMinutes,
            daysOfWeek: [dayValue]
          }
        };
        
        console.log('Adding availability event:', event);
        events.push(event);
      });
      
      // Render blocked times
      blocks.forEach(b => {
        // Handle both camelCase and PascalCase
        const reason = b.reason !== undefined ? b.reason : (b.Reason || "Blocked");
        const startUtc = b.startUtc !== undefined ? b.startUtc : b.StartUtc;
        const endUtc = b.endUtc !== undefined ? b.endUtc : b.EndUtc;
        
        events.push({
          title: reason,
          start: startUtc,
          end: endUtc,
          backgroundColor: "#f8d7da",
          borderColor: "#f5c2c7",
          textColor: "#842029",
          classNames: ['blocked-slot']
        });
      });
      
      console.log('Generated events:', events);
      return events;
    }

    calendar = new FullCalendar.Calendar(calEl, {
      initialView: "timeGridWeek",
      headerToolbar: false, // We'll use custom buttons
      height: "auto",
      aspectRatio: 1.35,
      nowIndicator: true,
      nowIndicatorClass: "fc-now-indicator",
      allDaySlot: false,
      slotMinTime: "00:00:00",
      slotMaxTime: "24:00:00",
      slotDuration: "00:30:00",
      slotLabelInterval: "01:00:00",
      slotLabelFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      },
      events: buildEvents(),
      eventDisplay: 'block',
      eventDidMount: function(arg) {
        // Debug: log events as they're mounted
        if (arg.event.display === 'background') {
          console.log('Background event mounted:', {
            title: arg.event.title,
            dayOfWeek: arg.event.extendedProps.dayOfWeek,
            startTime: arg.event.extendedProps.startTime,
            endTime: arg.event.extendedProps.endTime,
            daysOfWeek: arg.event.extendedProps.daysOfWeek
          });
        }
      },
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      },
      dayHeaderFormat: {
        weekday: 'short',
        day: 'numeric',
        month: 'short'
      },
      firstDay: 1, // Start week on Monday
      locale: 'en',
      // Don't set timeZone for recurring events - they use local time by default
      // timeZone: 'local' is the default, which is what we want for recurring weekly rules
      eventContent: function(arg) {
        if (arg.event.display === 'background') {
          return {
            html: `<div class="fc-bg-event-content" title="${arg.event.title}">${arg.event.title}</div>`
          };
        }
        return {
          html: `<div class="fc-event-title">${arg.event.title}</div>`
        };
      }
    });

    calendar.render();

    // Custom navigation buttons
    document.getElementById("calendarPrev")?.addEventListener("click", () => {
      calendar.prev();
    });
    document.getElementById("calendarNext")?.addEventListener("click", () => {
      calendar.next();
    });
    document.getElementById("calendarToday")?.addEventListener("click", () => {
      calendar.today();
    });

    // Refresh calendar when rules or blocks change (via form submission reload)
    // Calendar will rebuild on page reload, so no additional refresh needed
  });
</script>


