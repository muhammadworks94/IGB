@model List<IGB.Domain.Entities.CourseTopic>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    var course = (IGB.Domain.Entities.Course)ViewBag.Course;
    ViewData["Title"] = "Course Topics";
    var csrf = Antiforgery.GetAndStoreTokens(Context).RequestToken;
    var mainTopics = Model.Where(t => !t.ParentTopicId.HasValue).OrderBy(t => t.SortOrder).ThenBy(t => t.Title).ToList();
    var byParent = Model.Where(t => t.ParentTopicId.HasValue).GroupBy(t => t.ParentTopicId!.Value).ToDictionary(g => g.Key, g => g.OrderBy(x => x.SortOrder).ThenBy(x => x.Title).ToList());
}

<div class="breadcrumb-header">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="#">Courses</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("All", "Courses")">All Courses</a></li>
            <li class="breadcrumb-item active" aria-current="page">Topics - @course.Name</li>
        </ol>
    </nav>
    
    <!-- Title, and Action Buttons in one row -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-0">
        <h1 class="breadcrumb-title mb-0">Topics - @course.Name</h1>
        
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <div class="text-muted small">Drag topics to reorder, then click <b>Save order</b>.</div>
            <a asp-action="Create" asp-route-courseId="@course.Id" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-plus me-2"></i>Add Main Topic
            </a>
            <button type="button" class="btn btn-outline-primary btn-sm" id="saveOrderBtn">
                <i class="fas fa-save me-2"></i>Save order
            </button>
        </div>
    </div>
</div>

<div class="container-fluid">
    @if (TempData["Error"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Error"]!.ToString()!, Variant: "danger", Dismissible: true))" />
    }
    @if (TempData["Success"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Success"]!.ToString()!, Variant: "success", Dismissible: true))" />
    }

    <div class="card">
        <div class="card-body">
            <ul class="list-group" id="mainTopics">
                @foreach (var mt in mainTopics)
                {
                    <li class="list-group-item" data-id="@mt.Id">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-semibold">
                                    <i class="fas fa-grip-vertical me-2 text-muted"></i>@mt.Title
                                </div>
                                <div class="text-muted small">Main topic</div>
                            </div>
                            <div class="d-flex gap-2">
                                <a class="btn btn-sm btn-outline-primary" asp-action="Create" asp-route-courseId="@course.Id" asp-route-parentTopicId="@mt.Id">
                                    <i class="fas fa-plus me-1"></i>Subtopic
                                </a>
                                <a class="btn btn-sm btn-outline-secondary" asp-action="Edit" asp-route-id="@mt.Id">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </a>
                                <form method="post" asp-action="Delete" asp-route-id="@mt.Id" class="d-inline" onsubmit="return confirm('Delete topic and its subtopics?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash me-1"></i>Delete</button>
                                </form>
                            </div>
                        </div>

                        <ul class="list-group mt-3 subtopics" data-parent="@mt.Id">
                            @foreach (var st in (byParent.ContainsKey(mt.Id) ? byParent[mt.Id] : new List<IGB.Domain.Entities.CourseTopic>()))
                            {
                                <li class="list-group-item" data-id="@st.Id" data-parent="@mt.Id">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-grip-vertical me-2 text-muted"></i>@st.Title
                                            <div class="text-muted small">Subtopic</div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a class="btn btn-sm btn-outline-secondary" asp-action="Edit" asp-route-id="@st.Id">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </a>
                                            <form method="post" asp-action="Delete" asp-route-id="@st.Id" class="d-inline" onsubmit="return confirm('Delete subtopic?');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash me-1"></i>Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<script>
  (function () {
    // jQuery UI sortable (already included in layout)
    try {
      $("#mainTopics").sortable({ handle: ".fa-grip-vertical", placeholder: "bg-light" });
      $(".subtopics").sortable({ handle: ".fa-grip-vertical", placeholder: "bg-light" });
    } catch {}

    document.getElementById("saveOrderBtn")?.addEventListener("click", async function () {
      const courseId = @course.Id;
      const items = [];

      // main topics order
      document.querySelectorAll("#mainTopics > li.list-group-item").forEach((li, idx) => {
        const id = Number(li.getAttribute("data-id"));
        items.push({ id, parentTopicId: null, sortOrder: idx });
      });
      // subtopics order per parent
      document.querySelectorAll(".subtopics").forEach(ul => {
        const parentId = Number(ul.getAttribute("data-parent"));
        ul.querySelectorAll("li.list-group-item").forEach((li, idx) => {
          const id = Number(li.getAttribute("data-id"));
          items.push({ id, parentTopicId: parentId, sortOrder: idx });
        });
      });

      const res = await fetch("@Url.Action("Reorder", "CourseTopics")", {
        method: "POST",
        headers: { "Content-Type": "application/json", "RequestVerificationToken": "@csrf" },
        body: JSON.stringify({ courseId, items })
      });

      if (res.ok) {
        if (window.toastSuccess) window.toastSuccess("Topic order saved.");
        else alert("Topic order saved.");
      } else {
        if (window.toastError) window.toastError("Failed to save order.");
        else alert("Failed to save order.");
      }
    });
  })();
</script>


