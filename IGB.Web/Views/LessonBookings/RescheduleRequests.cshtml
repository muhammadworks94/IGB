@model IGB.Web.ViewModels.Admin.RescheduleRequestsViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Reschedule Requests";
    var csrf = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: "Reschedule Requests",
    Icon: "fas fa-calendar-alt",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Dashboard", Url.Action("Index", "Home")),
        new("Lessons"),
        new("Reschedule Requests")
    }
))

<div class="container-fluid">
    @if (TempData["Error"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Error"]!.ToString()!, Variant: "danger", Dismissible: true))" />
    }
    @if (TempData["Success"] != null)
    {
        <partial name="Components/_Alert" model="@(new IGB.Web.ViewModels.Components.AlertViewModel(TempData["Success"]!.ToString()!, Variant: "success", Dismissible: true))" />
    }

    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Search</label>
                    <input class="form-control" name="q" value="@Model.Query" placeholder="Student or course..." />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary" type="submit">Search</button>
                </div>
            </form>
        </div>
    </div>

    @{
        var tableVm = new TableShellViewModel(
            Id: "rescheduleRequests",
            Columns: new List<TableColumn>
            {
                new("Student"),
                new("Course"),
                new("Current (UTC)"),
                new("Requested Options (UTC)"),
                new("Reason"),
                new("Actions", CssClass: "text-end")
            },
            RenderRows: html =>
            {
                var sb = new System.Text.StringBuilder();
                foreach (var r in Model.Items)
                {
                    sb.AppendLine($@"
<tr>
  <td>{System.Net.WebUtility.HtmlEncode(r.StudentName)}</td>
  <td>{System.Net.WebUtility.HtmlEncode(r.CourseName)}</td>
  <td class='small text-muted'>{r.CurrentStartUtc:yyyy-MM-dd HH:mm} - {r.CurrentEndUtc:HH:mm}</td>
  <td class='small text-muted'>
    1) {r.Option1Utc:yyyy-MM-dd HH:mm}<br/>
    2) {r.Option2Utc:yyyy-MM-dd HH:mm}<br/>
    3) {r.Option3Utc:yyyy-MM-dd HH:mm}
  </td>
  <td class='small'>{System.Net.WebUtility.HtmlEncode(r.Reason ?? "")}</td>
  <td class='text-end'>
    <button class='btn btn-sm btn-primary' type='button' onclick='openApprove({r.LessonId})'>Approve</button>
    <button class='btn btn-sm btn-outline-danger' type='button' onclick='openReject({r.LessonId})'>Reject</button>
  </td>
</tr>");
                }
                return new Microsoft.AspNetCore.Html.HtmlString(sb.ToString());
            },
            Pagination: Model.Pagination,
            SearchQuery: Model.Query
        );
    }

    @await Html.PartialAsync("Components/_TableShell", tableVm)
</div>

<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="@Url.Action("ApproveReschedule","LessonBookings")">
                <input name="__RequestVerificationToken" type="hidden" value="@csrf" />
                <input type="hidden" name="lessonId" id="approveLessonId" />
                <div class="modal-header">
                    <h5 class="modal-title">Approve Reschedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Select option</label>
                    <select class="form-select" name="selectedOption">
                        <option value="1">Option 1</option>
                        <option value="2">Option 2</option>
                        <option value="3">Option 3</option>
                    </select>
                    <label class="form-label mt-3">Admin note (optional)</label>
                    <textarea class="form-control" name="adminNote" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Approve</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="@Url.Action("RejectReschedule","LessonBookings")">
                <input name="__RequestVerificationToken" type="hidden" value="@csrf" />
                <input type="hidden" name="lessonId" id="rejectLessonId" />
                <div class="modal-header">
                    <h5 class="modal-title">Reject Reschedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Reason / note</label>
                    <textarea class="form-control" name="adminNote" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
  function openApprove(id) {
    document.getElementById('approveLessonId').value = id;
    new bootstrap.Modal(document.getElementById('approveModal')).show();
  }
  function openReject(id) {
    document.getElementById('rejectLessonId').value = id;
    new bootstrap.Modal(document.getElementById('rejectModal')).show();
  }
</script>


