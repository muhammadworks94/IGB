@model List<IGB.Domain.Entities.CourseBooking>
@using IGB.Web.ViewModels.Components
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Pending Course Bookings";
    var q = ViewBag.Query as string;
    var currentPage = (int)(ViewBag.Page ?? 1);
    var pageSize = (int)(ViewBag.PageSize ?? 10);
    var total = (int)(ViewBag.Total ?? 0);
    var csrf = Antiforgery.GetAndStoreTokens(Context).RequestToken;
    var pagination = new PaginationViewModel(currentPage, pageSize, total, Action: "Pending", Controller: "CourseBookings", RouteValues: new { q });
}

@await Html.PartialAsync("_PageHeader", new PageHeaderViewModel(
    Title: "Pending Course Bookings",
    Icon: "fas fa-clock",
    Breadcrumbs: new List<BreadcrumbItem>
    {
        new("Home", Url.Action("Index", "Home")),
        new("Course Bookings")
    }
))

<div class="container-fluid">
    @{
        var tableVm = new TableShellViewModel(
            Id: "pendingCourseBookings",
            Columns: new List<TableColumn>
            {
                new("Student"),
                new("Course"),
                new("Grade"),
                new("Curriculum"),
                new("Requested"),
                new("Actions", CssClass: "text-end")
            },
            RenderRows: html =>
            {
                var sb = new System.Text.StringBuilder();
                foreach (var b in Model)
                {
                    var student = b.StudentUser?.FullName ?? b.StudentUser?.Email ?? b.StudentUserId.ToString();
                    var course = b.Course?.Name ?? "";
                    var grade = b.Course?.Grade?.Name ?? "";
                    var curriculum = b.Course?.Grade?.Curriculum?.Name ?? "";

                    var approveUrl = Url.Action("Approve", "CourseBookings") ?? "#";
                    var rejectUrl = Url.Action("Reject", "CourseBookings") ?? "#";

                    sb.AppendLine($@"
<tr>
  <td>{System.Net.WebUtility.HtmlEncode(student)}</td>
  <td>{System.Net.WebUtility.HtmlEncode(course)}</td>
  <td>{System.Net.WebUtility.HtmlEncode(grade)}</td>
  <td>{System.Net.WebUtility.HtmlEncode(curriculum)}</td>
  <td>{b.RequestedAt:yyyy-MM-dd HH:mm}</td>
  <td class='text-end'>
    <form method='post' action='{approveUrl}' class='d-inline'>
      <input name='__RequestVerificationToken' type='hidden' value='{csrf}' />
      <input type='hidden' name='id' value='{b.Id}' />
      <input type='hidden' name='q' value='{System.Net.WebUtility.HtmlEncode(q ?? "")}' />
      <input type='hidden' name='page' value='{currentPage}' />
      <input type='hidden' name='pageSize' value='{pageSize}' />
      <button type='submit' class='btn btn-sm btn-success'><i class='fas fa-check me-1'></i>Approve</button>
    </form>
    <form method='post' action='{rejectUrl}' class='d-inline ms-2'>
      <input name='__RequestVerificationToken' type='hidden' value='{csrf}' />
      <input type='hidden' name='id' value='{b.Id}' />
      <input type='hidden' name='q' value='{System.Net.WebUtility.HtmlEncode(q ?? "")}' />
      <input type='hidden' name='page' value='{currentPage}' />
      <input type='hidden' name='pageSize' value='{pageSize}' />
      <button type='submit' class='btn btn-sm btn-danger'><i class='fas fa-times me-1'></i>Reject</button>
    </form>
  </td>
</tr>");
                }

                return new Microsoft.AspNetCore.Html.HtmlString(sb.ToString());
            },
            Pagination: pagination,
            SearchQuery: q,
            SearchPlaceholder: "Student / course / grade / curriculum..."
        );
    }

    @await Html.PartialAsync("Components/_TableShell", tableVm)
</div>


