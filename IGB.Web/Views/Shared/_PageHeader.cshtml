@model IGB.Web.ViewModels.PageHeaderViewModel

<div class="breadcrumb-header">
    <!-- Breadcrumbs -->
    @if (Model.Breadcrumbs != null && Model.Breadcrumbs.Count > 0)
    {
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb mb-0">
                @for (var i = 0; i < Model.Breadcrumbs.Count; i++)
                {
                    var item = Model.Breadcrumbs[i];
                    var isLast = i == Model.Breadcrumbs.Count - 1;
                    var hasUrl = !string.IsNullOrWhiteSpace(item.Url);

                    if (!isLast && hasUrl)
                    {
                        <li class="breadcrumb-item"><a href="@item.Url">@item.Text</a></li>
                    }
                    else
                    {
                        <li class="breadcrumb-item active" aria-current="page">@item.Text</li>
                    }
                }
            </ol>
        </nav>
    }

    <!-- Title, Subtitle, Search, Filters, and Action Buttons -->
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-0">
        <div class="flex-grow-1">
            <h1 class="breadcrumb-title mb-0">
                @if (!string.IsNullOrWhiteSpace(Model.Icon))
                {
                    <i class="@Model.Icon me-2"></i>
                }
                else
                {
                    <i class="fas fa-cog me-2"></i>
                }@Model.Title
            </h1>
            @if (!string.IsNullOrWhiteSpace(Model.Subtitle))
            {
                <p class="breadcrumb-subtitle mb-0 mt-1 text-muted">@Model.Subtitle</p>
            }
        </div>
        
        <!-- Right Side: Search, Filters, and Action Buttons -->
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <!-- Search Form -->
            @if (Model.Search != null)
            {
                <form method="@(Model.Search.FormMethod ?? "get")" 
                      action="@(Model.Search.FormAction ?? "")" 
                      class="d-flex gap-2 align-items-center">
                    @* Preserve filter values when searching *@
                    @if (Model.Filters != null && Model.Filters.Count > 0)
                    {
                        @foreach (var f in Model.Filters)
                        {
                            @if (f.Value != null && f.Value != "")
                            {
                                <input type="hidden" name="@f.Name" value="@f.Value" />
                            }
                        }
                    }
                    <div style="width: 250px;">
                        <input class="form-control form-control-sm" 
                               name="@(Model.Search.QueryParamName ?? "q")" 
                               value="@Model.Search.CurrentValue" 
                               placeholder="@(Model.Search.Placeholder ?? "Search...")" />
                    </div>
                    <button class="btn btn-primary btn-sm" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                    @if (Model.Search.ShowClearButton && !string.IsNullOrWhiteSpace(Model.Search.CurrentValue))
                    {
                        <a class="btn btn-outline-secondary btn-sm" 
                           href="@(Model.Search.ClearButtonUrl ?? "#")">
                            <i class="fas fa-times"></i>
                        </a>
                    }
                </form>
            }
            
            <!-- Filters -->
            @if (Model.Filters != null && Model.Filters.Count > 0)
            {
             
                    // Group filters: separate date filters from others
                    var dateFilters = Model.Filters.Where(f => f.Type == "date").ToList();
                    var otherFilters = Model.Filters.Where(f => f.Type != "date").ToList();
              
                
                @* Date filters grouped together with Apply button *@
                @if (dateFilters.Count > 0)
                {
                    <form method="get" action="@Context.Request.Path" class="d-flex gap-2 align-items-center" id="dateFiltersForm">
                        @* Preserve search query *@
                        @if (Model.Search != null && !string.IsNullOrWhiteSpace(Model.Search.CurrentValue))
                        {
                            <input type="hidden" name="@(Model.Search.QueryParamName ?? "q")" value="@Model.Search.CurrentValue" />
                        }
                        @* Preserve other non-date filters *@
                        @foreach (var otherFilter in otherFilters)
                        {
                            @if (otherFilter.Value != null && otherFilter.Value != "")
                            {
                                <input type="hidden" name="@otherFilter.Name" value="@otherFilter.Value" />
                            }
                        }
                        
                        @foreach (var filter in dateFilters)
                        {
                            <label class="text-muted small mb-0" for="@filter.Name">@filter.Label</label>
                            <input type="date" 
                                   id="@filter.Name" 
                                   name="@filter.Name" 
                                   value="@filter.Value" 
                                   placeholder="@filter.Placeholder"
                                   class="form-control form-control-sm @filter.CssClass" 
                                   style="width: auto; min-width: 150px;" />
                        }
                        <button class="btn btn-primary btn-sm" type="submit">
                            <i class="fas fa-filter me-1"></i>Apply
                        </button>
                    </form>
                }
                
                @* Other filters (select, input) - each in its own form with auto-submit *@
                @foreach (var filter in otherFilters)
                {
                    <form method="get" action="@Context.Request.Path" class="d-flex gap-2 align-items-center">
                        @* Preserve search query and other filters when this filter changes *@
                        @if (Model.Search != null && !string.IsNullOrWhiteSpace(Model.Search.CurrentValue))
                        {
                            <input type="hidden" name="@(Model.Search.QueryParamName ?? "q")" value="@Model.Search.CurrentValue" />
                        }
                        @foreach (var otherFilter in Model.Filters)
                        {
                            @if (otherFilter.Name != filter.Name && otherFilter.Value != null && otherFilter.Value != "")
                            {
                                <input type="hidden" name="@otherFilter.Name" value="@otherFilter.Value" />
                            }
                        }
                        
                        @if (filter.Type == "select")
                        {
                            <label class="text-muted small mb-0" for="@filter.Name">@filter.Label</label>
                            <select id="@filter.Name" 
                                    name="@filter.Name" 
                                    class="form-select form-select-sm @filter.CssClass" 
                                    style="width: auto;"
                                    onchange="this.form.submit()">
                                @if (filter.Options != null)
                                {
                                    @foreach (var option in filter.Options)
                                    {
                                        <option value="@option.Key" selected="@(option.Key == filter.Value)">@option.Value</option>
                                    }
                                }
                            </select>
                        }
                        else if (filter.Type == "input")
                        {
                            <label class="text-muted small mb-0" for="@filter.Name">@filter.Label</label>
                            <input type="text" 
                                   id="@filter.Name" 
                                   name="@filter.Name" 
                                   value="@filter.Value" 
                                   placeholder="@filter.Placeholder"
                                   class="form-control form-control-sm @filter.CssClass" 
                                   style="width: auto;" />
                        }
                    </form>
                }
            }
            
            <!-- Action Buttons -->
            @if (Model.ActionButtons != null && Model.ActionButtons.Count > 0)
            {
                @foreach (var button in Model.ActionButtons)
                {
                    var btnClass = $"btn btn-{button.ButtonType} btn-sm";
                    var hasBadge = !string.IsNullOrWhiteSpace(button.BadgeText);
                    
                    if (!string.IsNullOrWhiteSpace(button.ModalTarget))
                    {
                        <button type="button" 
                                class="@btnClass @(hasBadge ? "position-relative" : "")" 
                                data-bs-toggle="modal" 
                                data-bs-target="@button.ModalTarget"
                                @if (!string.IsNullOrWhiteSpace(button.OnClick)) { <text>onclick="@button.OnClick"</text> }>
                            @if (!string.IsNullOrWhiteSpace(button.Icon))
                            {
                                <i class="@button.Icon"></i>
                            }
                            @button.Text
                            @if (hasBadge)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-@button.BadgeVariant text-dark" style="font-size: 0.7rem;">
                                    @button.BadgeText
                                </span>
                            }
                        </button>
                    }
                    else if (!string.IsNullOrWhiteSpace(button.Url))
                    {
                        <a class="@btnClass @(hasBadge ? "position-relative" : "")" 
                           href="@button.Url"
                           @if (!string.IsNullOrWhiteSpace(button.OnClick)) { <text>onclick="@button.OnClick"</text> }>
                            @if (!string.IsNullOrWhiteSpace(button.Icon))
                            {
                                <i class="@button.Icon"></i>
                            }
                            @button.Text
                            @if (hasBadge)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-@button.BadgeVariant text-dark" style="font-size: 0.7rem;">
                                    @button.BadgeText
                                </span>
                            }
                        </a>
                    }
                    else if (button.IsSubmit)
                    {
                        <button type="submit" 
                                class="@btnClass @(hasBadge ? "position-relative" : "")"
                                @if (!string.IsNullOrWhiteSpace(button.OnClick)) { <text>onclick="@button.OnClick"</text> }>
                            @if (!string.IsNullOrWhiteSpace(button.Icon))
                            {
                                <i class="@button.Icon"></i>
                            }
                            @button.Text
                            @if (hasBadge)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-@button.BadgeVariant text-dark" style="font-size: 0.7rem;">
                                    @button.BadgeText
                                </span>
                            }
                        </button>
                    }
                    else
                    {
                        <button type="button" 
                                class="@btnClass @(hasBadge ? "position-relative" : "")"
                                @if (!string.IsNullOrWhiteSpace(button.OnClick)) { <text>onclick="@button.OnClick"</text> }>
                            @if (!string.IsNullOrWhiteSpace(button.Icon))
                            {
                                <i class="@button.Icon"></i>
                            }
                            @button.Text
                            @if (hasBadge)
                            {
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-@button.BadgeVariant text-dark" style="font-size: 0.7rem;">
                                    @button.BadgeText
                                </span>
                            }
                        </button>
                    }
                }
            }
        </div>
    </div>
</div>


