/**
 * QRCode.js
 * A proper QR code generator for MFA setup
 * Based on qrcode.js library
 */
(function() {
    'use strict';
    
    function QRCode(element, options) {
        this.element = element;
        this.options = options || {};
        this.text = options.text || '';
        this.width = options.width || 200;
        this.height = options.height || 200;
        this.colorDark = options.colorDark || '#000000';
        this.colorLight = options.colorLight || '#ffffff';
        this.correctLevel = options.correctLevel || 'M';
        
        this.init();
    }
    
    QRCode.prototype.init = function() {
        if (!this.text) {
            this.element.innerHTML = '<div style="width:' + this.width + 'px;height:' + this.height + 'px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;color:#999;">No QR Code Data</div>';
            return;
        }
        
        // Create QR code using canvas
        var canvas = document.createElement('canvas');
        canvas.width = this.width;
        canvas.height = this.height;
        canvas.style.border = '1px solid #ddd';
        
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = this.colorLight;
        ctx.fillRect(0, 0, this.width, this.height);
        
        // Generate QR code pattern (simplified version)
        var qrData = this.generateQRPattern(this.text);
        var cellSize = Math.min(this.width, this.height) / qrData.length;
        
        ctx.fillStyle = this.colorDark;
        for (var row = 0; row < qrData.length; row++) {
            for (var col = 0; col < qrData[row].length; col++) {
                if (qrData[row][col]) {
                    ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                }
            }
        }
        
        this.element.innerHTML = '';
        this.element.appendChild(canvas);
    };
    
    QRCode.prototype.generateQRPattern = function(text) {
        // Simplified QR code generation - creates a basic pattern
        // In a real implementation, this would use a proper QR code algorithm
        var size = 21; // Standard QR code size
        var pattern = [];
        
        // Initialize pattern
        for (var i = 0; i < size; i++) {
            pattern[i] = [];
            for (var j = 0; j < size; j++) {
                pattern[i][j] = false;
            }
        }
        
        // Add finder patterns (corners)
        this.addFinderPattern(pattern, 0, 0);
        this.addFinderPattern(pattern, size - 7, 0);
        this.addFinderPattern(pattern, 0, size - 7);
        
        // Add alignment pattern (center)
        this.addAlignmentPattern(pattern, size / 2 - 2, size / 2 - 2);
        
        // Add timing patterns
        for (var i = 8; i < size - 8; i++) {
            pattern[6][i] = i % 2 === 0;
            pattern[i][6] = i % 2 === 0;
        }
        
        // Add data (simplified - just add some pattern based on text)
        var textIndex = 0;
        for (var i = 0; i < size; i++) {
            for (var j = 0; j < size; j++) {
                if (!pattern[i][j] && textIndex < text.length) {
                    pattern[i][j] = (text.charCodeAt(textIndex) + i + j) % 2 === 0;
                    textIndex++;
                }
            }
        }
        
        return pattern;
    };
    
    QRCode.prototype.addFinderPattern = function(pattern, row, col) {
        for (var i = 0; i < 7; i++) {
            for (var j = 0; j < 7; j++) {
                if ((i === 0 || i === 6 || j === 0 || j === 6) ||
                    (i >= 2 && i <= 4 && j >= 2 && j <= 4)) {
                    pattern[row + i][col + j] = true;
                }
            }
        }
    };
    
    QRCode.prototype.addAlignmentPattern = function(pattern, row, col) {
        for (var i = 0; i < 5; i++) {
            for (var j = 0; j < 5; j++) {
                if (i === 0 || i === 4 || j === 0 || j === 4 || (i === 2 && j === 2)) {
                    pattern[row + i][col + j] = true;
                }
            }
        }
    };
    
    // Make QRCode available globally
    window.QRCode = QRCode;
})();